<!DOCTYPE html>
<!-- saved from url=(0042)http://master.tech-camp.in/curriculums/899 -->
<html lang="ja"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><style type="text/css">@charset "UTF-8";[ng\:cloak],[ng-cloak],[data-ng-cloak],[x-ng-cloak],.ng-cloak,.x-ng-cloak,.ng-hide:not(.ng-hide-animate){display:none !important;}ng\:form{display:block;}</style>
<script type="text/javascript" src="./応用機能の実装_files/d896f56e42"></script><script src="./応用機能の実装_files/nr-1026.min.js"></script><script async="" src="./応用機能の実装_files/analytics.js"></script><script type="text/javascript">window.NREUM||(NREUM={});NREUM.info={"beacon":"bam.nr-data.net","errorBeacon":"bam.nr-data.net","licenseKey":"d896f56e42","applicationID":"38109881","transactionName":"Jg5cQxBdCgkAQhYFRhcTW1QXXhMIFh9KDlwS","queueTime":0,"applicationTime":69,"agent":""}</script>
<script type="text/javascript">window.NREUM||(NREUM={}),__nr_require=function(e,n,t){function r(t){if(!n[t]){var o=n[t]={exports:{}};e[t][0].call(o.exports,function(n){var o=e[t][1][n];return r(o||n)},o,o.exports)}return n[t].exports}if("function"==typeof __nr_require)return __nr_require;for(var o=0;o<t.length;o++)r(t[o]);return r}({1:[function(e,n,t){function r(){}function o(e,n,t){return function(){return i(e,[c.now()].concat(u(arguments)),n?null:this,t),n?void 0:this}}var i=e("handle"),a=e(2),u=e(3),f=e("ee").get("tracer"),c=e("loader"),s=NREUM;"undefined"==typeof window.newrelic&&(newrelic=s);var p=["setPageViewName","setCustomAttribute","setErrorHandler","finished","addToTrace","inlineHit","addRelease"],d="api-",l=d+"ixn-";a(p,function(e,n){s[n]=o(d+n,!0,"api")}),s.addPageAction=o(d+"addPageAction",!0),s.setCurrentRouteName=o(d+"routeName",!0),n.exports=newrelic,s.interaction=function(){return(new r).get()};var m=r.prototype={createTracer:function(e,n){var t={},r=this,o="function"==typeof n;return i(l+"tracer",[c.now(),e,t],r),function(){if(f.emit((o?"":"no-")+"fn-start",[c.now(),r,o],t),o)try{return n.apply(this,arguments)}finally{f.emit("fn-end",[c.now()],t)}}}};a("setName,setAttribute,save,ignore,onEnd,getContext,end,get".split(","),function(e,n){m[n]=o(l+n)}),newrelic.noticeError=function(e){"string"==typeof e&&(e=new Error(e)),i("err",[e,c.now()])}},{}],2:[function(e,n,t){function r(e,n){var t=[],r="",i=0;for(r in e)o.call(e,r)&&(t[i]=n(r,e[r]),i+=1);return t}var o=Object.prototype.hasOwnProperty;n.exports=r},{}],3:[function(e,n,t){function r(e,n,t){n||(n=0),"undefined"==typeof t&&(t=e?e.length:0);for(var r=-1,o=t-n||0,i=Array(o<0?0:o);++r<o;)i[r]=e[n+r];return i}n.exports=r},{}],4:[function(e,n,t){n.exports={exists:"undefined"!=typeof window.performance&&window.performance.timing&&"undefined"!=typeof window.performance.timing.navigationStart}},{}],ee:[function(e,n,t){function r(){}function o(e){function n(e){return e&&e instanceof r?e:e?f(e,u,i):i()}function t(t,r,o,i){if(!d.aborted||i){e&&e(t,r,o);for(var a=n(o),u=m(t),f=u.length,c=0;c<f;c++)u[c].apply(a,r);var p=s[y[t]];return p&&p.push([b,t,r,a]),a}}function l(e,n){v[e]=m(e).concat(n)}function m(e){return v[e]||[]}function w(e){return p[e]=p[e]||o(t)}function g(e,n){c(e,function(e,t){n=n||"feature",y[t]=n,n in s||(s[n]=[])})}var v={},y={},b={on:l,emit:t,get:w,listeners:m,context:n,buffer:g,abort:a,aborted:!1};return b}function i(){return new r}function a(){(s.api||s.feature)&&(d.aborted=!0,s=d.backlog={})}var u="nr@context",f=e("gos"),c=e(2),s={},p={},d=n.exports=o();d.backlog=s},{}],gos:[function(e,n,t){function r(e,n,t){if(o.call(e,n))return e[n];var r=t();if(Object.defineProperty&&Object.keys)try{return Object.defineProperty(e,n,{value:r,writable:!0,enumerable:!1}),r}catch(i){}return e[n]=r,r}var o=Object.prototype.hasOwnProperty;n.exports=r},{}],handle:[function(e,n,t){function r(e,n,t,r){o.buffer([e],r),o.emit(e,n,t)}var o=e("ee").get("handle");n.exports=r,r.ee=o},{}],id:[function(e,n,t){function r(e){var n=typeof e;return!e||"object"!==n&&"function"!==n?-1:e===window?0:a(e,i,function(){return o++})}var o=1,i="nr@id",a=e("gos");n.exports=r},{}],loader:[function(e,n,t){function r(){if(!x++){var e=h.info=NREUM.info,n=d.getElementsByTagName("script")[0];if(setTimeout(s.abort,3e4),!(e&&e.licenseKey&&e.applicationID&&n))return s.abort();c(y,function(n,t){e[n]||(e[n]=t)}),f("mark",["onload",a()+h.offset],null,"api");var t=d.createElement("script");t.src="https://"+e.agent,n.parentNode.insertBefore(t,n)}}function o(){"complete"===d.readyState&&i()}function i(){f("mark",["domContent",a()+h.offset],null,"api")}function a(){return E.exists&&performance.now?Math.round(performance.now()):(u=Math.max((new Date).getTime(),u))-h.offset}var u=(new Date).getTime(),f=e("handle"),c=e(2),s=e("ee"),p=window,d=p.document,l="addEventListener",m="attachEvent",w=p.XMLHttpRequest,g=w&&w.prototype;NREUM.o={ST:setTimeout,CT:clearTimeout,XHR:w,REQ:p.Request,EV:p.Event,PR:p.Promise,MO:p.MutationObserver};var v=""+location,y={beacon:"bam.nr-data.net",errorBeacon:"bam.nr-data.net",agent:"js-agent.newrelic.com/nr-1026.min.js"},b=w&&g&&g[l]&&!/CriOS/.test(navigator.userAgent),h=n.exports={offset:u,now:a,origin:v,features:{},xhrWrappable:b};e(1),d[l]?(d[l]("DOMContentLoaded",i,!1),p[l]("load",r,!1)):(d[m]("onreadystatechange",o),p[m]("onload",r)),f("mark",["firstbyte",u],null,"api");var x=0,E=e(4)},{}]},{},["loader"]);</script><title>応用機能の実装</title><link href="./応用機能の実装_files/application-ee235c2c69f0123100ca0233ac9bf6ea4eefd02b15a188f1f5e7c9fa904bfdfb.css" media="all" rel="stylesheet"><script src="./応用機能の実装_files/bundle.app-fbb361722a822ae8266ace1de986c9e7bc61c1f64d90d9bc8a7d7012db97eb6a.js"></script><link href="./応用機能の実装_files/icon.css" rel="stylesheet"><meta content="authenticity_token" name="csrf-param">
<meta content="NUe0hjVfS5/ZqJXdOmK8qNfTJnnraK6P9tZwDoxHCtw=" name="csrf-token"><link href="http://master.tech-camp.in/favicon.ico" rel="icon" sizes="16x16 32x32 48x48 128x128 256x256"><link href="./応用機能の実装_files/font-awesome.min.css" rel="stylesheet"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-33391559-9', 'auto');
ga('send', 'pageview');</script></head><body ng-app="techMaster" class="ng-scope"><div class="header navbar main_header navbar-fixed-top" id="header" role="navigation"><div class="container"><div class="navbar-header"><button aria-controls="navbar" aria-expanded="false" class="navbar-toggle collapsed" data-target="#navbar" data-toggle="collapse" type="button"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="http://master.tech-camp.in/" target="_self"><img alt="TECH::MASTER" src="./応用機能の実装_files/logo-a092b24686f2404f48e1ef25bd8bfe7445b458e4587da135059132b867b10cbd.svg"></a></div><div class="navbar-collapse collapse" id="navbar"><ul class="nav navbar-nav navbar-right"><li id="after_graduate"><p>卒業後の目標:研修内容で習った事関して...</p></li><li><p>終了まで<strong>9</strong>日</p></li><script>$(function() {
  var menuHeight = $(window).height() - 80;
  $('#js-menuheight').css('max-height', menuHeight + 'px');

  $('.js-switch-list').on('click', function(e) {
    e.stopPropagation();
    $('.js-list-group').toggle();
  });

  $('.js-course-select').on('click', function(e) {
    e.stopPropagation();
    var checkBox = $(this).find('input[type=checkbox]');
    checkBox.prop('checked', !checkBox.prop('checked'));
    $(this).hasClass('bg-info') ? $(this).removeClass('bg-info') : $(this).addClass('bg-info');
  });
});</script><li><p>平野 水稀</p></li><li class="profileDropdown" data-target="#user-list"><a class="js-dropdown" id="profileDropdown"><img alt="平野 水稀" class="avatar" src="./応用機能の実装_files/noimage.png"><i aria-hidden="true" class="fa fa-caret-down"></i></a><ul class="inner-list" id="user-list" style="display: none;"><li><a href="http://master.tech-camp.in/me" target="_self">アカウント</a></li><li><a href="http://master.tech-camp.in/users" target="_self">一期生一覧</a></li><li><a href="https://tech-camp.in/#faq" target="_blank">FAQ</a></li></ul></li><script>$(function() {
  $('#profileDropdown').on('click', function() {
    $('.popover').toggle();
  });
});</script></ul></div></div></div><div class=""></div><!-- ngView:  --><div ng-view="" class="ng-scope"><curriculum class="ng-scope" style="display: inline;">
  <div class="container" id="curriculum">
    <div class="row curriculum-inner">
      <div class="col-lg-12 main" ng-init="init()">
        <div class="page-header page" style="background-image: url(&quot;https://tech-master.s3-ap-northeast-1.amazonaws.com/uploads/c_title_image/content/267/7112553961_9e78286ae8_k.jpg?X-Amz-Expires=600&amp;X-Amz-Date=20170519T100752Z&amp;X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=AKIAINAMMGOFK72FFELA/20170519/ap-northeast-1/s3/aws4_request&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=a2f3f67cbab6599403d4ff2f51164076bea27ac072719243499248cc97cc9b9d&quot;);" ng-show="curriculum.image">
  <h1 class="ng-binding">
    Laravelアプリケーション開発2 第4章<small class="ng-binding">〜応用機能の実装〜</small>
  </h1>
  <!-- ngIf: curriculum.image.description.length --><div class="flickr_attr ng-binding ng-scope" ng-if="curriculum.image.description.length">
    ノートルダム大聖堂。1789年のフランス革命の影響により他の教会同様ノートルダム大聖堂も襲撃を受け破壊活動、略奪が繰り返されていました。しかし、1831年のヴィクトル・ユーゴーの小説『ノートルダム・ド・パリ』の舞台になったことがきっかけに国民全体に大聖堂復興運動の意義を訴えることになり政府から全体的補修が決定されたそうです。<a href="https://www.flickr.com/photos/mathieu_distefano/7112553961/" target="_blank" class="ng-binding">Selden Vestrit - Cathédrale Notre-Dame de Paris</a>
  </div><!-- end ngIf: curriculum.image.description.length -->
</div>
      </div>
      <div class="col-md-9 col-sm-12" id="curriculumMainContainer">
        <div class="curriculum_content">
          <div class="curriculum_text ng-scope" compile-progress-notifier="willCompiledCurriculumText" ng-controller="CurriculumHintController"><h1 class="ng-scope" id="1">学習目標</h1>

<p class="ng-scope">応用的な課題を解きながら、映画レビューサイトをさらに複雑なアプリケーションにしていきましょう。</p>

<h1 class="ng-scope" id="2">学習課題</h1>

<p class="ng-scope">ひと通り動くレビューサイトが出来たと思います。<br>
この章はこのレビューサイトに機能を増やして、よりアプリケーションとしてのクオリティを上げていきます。</p>

<p class="ng-scope">この章では少し応用的な課題が出てくるので、わからないときは調べながら進めていきましょう。</p>

<h1 class="ng-scope" id="3">STEP0：作業の準備をしよう</h1>

<p class="ng-scope">本章では新しくビューを追加するので、そのためのHTMLやCSSファイルが必要となります。本セクションでは、本格的に学習に入る前にこれらの必要なファイルの準備を行います。</p>

<h2 class="ng-scope" id="4">ファイルをダウンロードしよう</h2>

<p class="ng-scope">以下のリンクから新しいHTML、CSSファイルの入っているzipファイルをダウンロードしましょう。</p>

<p class="ng-scope"><a href="https://www.dropbox.com/s/o0hmrc58h7co705/Laravel2-4.zip?dl=1" target="_blank">Laravel2-4.zip</a></p>

<p class="ng-scope">zipファイルを解凍し、以下のようになっていることを確認してください。</p>

<ul class="filetree ng-scope">
  <li class="t-folder"> Laravel2-4
    <ul>
      <li class="t-folder"> users
        <ul>
          <li class="t-file"> show.blade.php</li>
          <ul class="t-folder"> auth
            <li class="t-file"> register.blade.php</li>
            <li class="t-file"> login.blade.php</li>
          </ul>
          </ul>
</li>
        </ul>
    </li>
</ul>
  


<p class="ng-scope">zipファイルを解凍できない場合はメンターにお知らせください。</p>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4235" class="ng-pristine ng-valid ng-scope">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-5906" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-5906" name="check-5906" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">Laravel2-4フォルダをダウンロードできた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h1 class="ng-scope" id="5">STEP1：レビューの評価を星として表示させよう</h1>

<p class="ng-scope">現在、レビューの評価がどこにも表示されていません。moooviでは<strong>レビューの評価を星として表示</strong>します。</p>

<p class="ng-scope">レビューの評価を表示させる画面は<strong>トップページ</strong>と<strong>作品ページ</strong>の2つです。</p>

<ul class="ng-scope">
<li>トップページ</li>
</ul>

<p class="ng-scope"><img src="./応用機能の実装_files/18.png" alt="レビュー1"></p>

<ul class="ng-scope">
<li>作品ページ</li>
</ul>

<p class="ng-scope"><img src="./応用機能の実装_files/19.png" alt="レビュー2"></p>

<p class="ng-scope">これを以下のように星で評価を表示できるようにしましょう。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/13.png" alt="レビュー"></p>

<p class="ng-scope">星の数はそれぞれ画像が用意されており、以下のようにして表示することができます。<br>
トップページであるindex.blade.php、作品ページであるshow.blade.phpを確認しましょう。</p>

<div class="code-frame ng-scope" data-lang="html">
<div class="code-lang"><span class="bold">index.blade.php</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td>
<td class="code">
<div class="highlight"><pre>@extends('layouts.review_site')

@section('content')
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"main_cnt_wrapper"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjContentsBody"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"yjContainer"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"yjGuid"</span><span class="nt">&gt;&lt;a</span> <span class="na">id=</span><span class="s">"yjContentsStart"</span> <span class="na">name=</span><span class="s">"yjContentsStart"</span><span class="nt">&gt;&lt;/a&gt;&lt;img</span> <span class="na">alt=</span><span class="s">"ここから本文です"</span> <span class="na">height=</span><span class="s">"1"</span> <span class="na">src=</span><span class="s">"http://i.yimg.jp/yui/jp/tmpl/1.1.0/audionav.gif"</span> <span class="na">width=</span><span class="s">"1"</span><span class="nt">&gt;&lt;/span&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjMain"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;article</span> <span class="na">class=</span><span class="s">"section"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"header header--section"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;h2</span> <span class="na">class=</span><span class="s">"text-middle"</span><span class="nt">&gt;</span>
                  <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"icon-movie color-gray-light"</span><span class="nt">&gt;&lt;/i&gt;</span>新着作品
                <span class="nt">&lt;/h2&gt;</span>
              <span class="nt">&lt;/header&gt;</span>
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"thumbnails thumbnail--movies row grid4 js-lazy-load-images js-my-check-stats"</span> <span class="na">id=</span><span class="s">"list-module"</span><span class="nt">&gt;</span>
                @foreach ($products as $product)
                  <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"col"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/products/{{ $product-&gt;id }}"</span><span class="nt">&gt;&lt;div</span> <span class="na">class=</span><span class="s">"thumbnail__figure"</span> <span class="na">style=</span><span class="s">"background-image:url({{ $product-&gt;image_url }})"</span><span class="nt">&gt;&lt;/div&gt;&lt;/a&gt;</span>
                    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"thumbnail__caption"</span><span class="nt">&gt;</span>
                      <span class="nt">&lt;h3</span> <span class="na">class=</span><span class="s">"text-xsmall text-overflow"</span> <span class="na">title=</span><span class="s">"{{ $product-&gt;title }}"</span><span class="nt">&gt;</span>
                        {{ $product-&gt;title }}
                      <span class="nt">&lt;/h3&gt;</span>
                      <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"text-small"</span><span class="nt">&gt;</span>
<span class="hll">                        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"rating-star"</span><span class="nt">&gt;</span>
</span><span class="hll">                          <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"star-actived rate-[ここに評価を表示]0"</span><span class="nt">&gt;&lt;/i&gt;</span>
</span><span class="hll">                        <span class="nt">&lt;/span&gt;</span>
</span>                      <span class="nt">&lt;/p&gt;</span>
                    <span class="nt">&lt;/div&gt;</span>
                  <span class="nt">&lt;/li&gt;</span>
                @endforeach
              <span class="nt">&lt;/ul&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;/article&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjSub"</span><span class="nt">&gt;</span>
@endsection
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">星の数は<strong>i要素のクラスのrate-[ここに評価を表示]0</strong>と対応しています。[ここに評価を表示]には評価の数字（1~10）が入ります。各評価の星の数は以下の通りです。</p>

<table class="ng-scope">
<thead>
<tr>
<th style="text-align: center">クラス名</th>
<th style="text-align: center">星の数</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">rate-10</td>
<td style="text-align: center"><img src="./応用機能の実装_files/03.png" alt=""></td>
</tr>
<tr>
<td style="text-align: center">rate-20</td>
<td style="text-align: center"><img src="./応用機能の実装_files/04.png" alt=""></td>
</tr>
<tr>
<td style="text-align: center">rate-30</td>
<td style="text-align: center"><img src="./応用機能の実装_files/05.png" alt=""></td>
</tr>
<tr>
<td style="text-align: center">rate-40</td>
<td style="text-align: center"><img src="./応用機能の実装_files/06.png" alt=""></td>
</tr>
<tr>
<td style="text-align: center">rate-50</td>
<td style="text-align: center"><img src="./応用機能の実装_files/07.png" alt=""></td>
</tr>
<tr>
<td style="text-align: center">rate-60</td>
<td style="text-align: center"><img src="./応用機能の実装_files/08.png" alt=""></td>
</tr>
<tr>
<td style="text-align: center">rate-70</td>
<td style="text-align: center"><img src="./応用機能の実装_files/09.png" alt=""></td>
</tr>
<tr>
<td style="text-align: center">rate-80</td>
<td style="text-align: center"><img src="./応用機能の実装_files/10.png" alt=""></td>
</tr>
<tr>
<td style="text-align: center">rate-90</td>
<td style="text-align: center"><img src="./応用機能の実装_files/11.png" alt=""></td>
</tr>
<tr>
<td style="text-align: center">rate-100</td>
<td style="text-align: center"><img src="./応用機能の実装_files/12.png" alt=""></td>
</tr>
</tbody>
</table>

<p class="ng-scope">それぞれのhtml.erbファイルにおいて、<code>rate-[ここに評価を表示]0</code>の[ここに評価を表示]に評価の数値が入るようにしていきます。</p>

<h3 class="ng-scope">
<i class="icon dashboard"></i> 作業内容</h3>

<h5 class="ng-scope">１．個別の作品ページでレビューの星を表示する</h5>

<h5 class="ng-scope">２．映画一覧ページでそれぞれの映画の平均評価を取得する</h5>

<h5 class="ng-scope">３．Product.phpにメソッドを定義する</h5>

<h2 class="ng-scope" id="6">１．個別の作品ページでレビューの星を表示する</h2>

<p class="ng-scope">作品ページでは、アソシエーションを用いることでコントローラーで定義している<code>$product</code>から関連するreviewsテーブルのレコードを全て取得しています。reviewsテーブルのレコードは、評価の数値が入るカラム、<code>rate</code>カラムを持っているので、それをそのまま取得し、先ほどの例の<code>[ここに評価を表示]</code>の部分で利用すれば良いでしょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> resources/views/products/show.blade.phpを以下のように編集しましょう</h3>

<div class="code-frame ng-scope" data-lang="html">
<div class="code-lang"><span class="bold">show.blade.php</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48</pre></div></td>
<td class="code">
<div class="highlight"><pre>@extends('layout')

@section('content')
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"main_cnt_wrapper"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjContentsBody"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"yjContainer"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"yjGuid"</span><span class="nt">&gt;&lt;a</span> <span class="na">id=</span><span class="s">"yjContentsStart"</span> <span class="na">name=</span><span class="s">"yjContentsStart"</span><span class="nt">&gt;&lt;/a&gt;&lt;img</span> <span class="na">alt=</span><span class="s">"ここから本文です"</span> <span class="na">height=</span><span class="s">"1"</span> <span class="na">src=</span><span class="s">"http://i.yimg.jp/yui/jp/tmpl/1.1.0/audionav.gif"</span> <span class="na">width=</span><span class="s">"1"</span><span class="nt">&gt;&lt;/span&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjMain"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;article</span> <span class="na">class=</span><span class="s">"section"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"header header--section"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;h2</span> <span class="na">class=</span><span class="s">"text-middle"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"icon-movie color-gray-light"</span><span class="nt">&gt;&lt;/i&gt;</span>{{ $product-&gt;title }}
              <span class="nt">&lt;/h2&gt;</span>
            <span class="nt">&lt;/header&gt;</span>
            <span class="nt">&lt;p</span> <span class="na">style=</span><span class="s">"text-align: center"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"{{ $product-&gt;image_url }}"</span> <span class="na">alt=</span><span class="s">"{{ $product-&gt;title }}"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;/p&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"text-align: right"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/products/{{ $product-&gt;id }}/reviews/create"</span><span class="nt">&gt;</span>この作品を投稿する<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
            <span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"header header--section"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;h2</span> <span class="na">class=</span><span class="s">"text-middle"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"icon-movie color-gray-light"</span><span class="nt">&gt;&lt;/i&gt;</span>みんなのレビュー
              <span class="nt">&lt;/h2&gt;</span>
            <span class="nt">&lt;/header&gt;</span>
            <span class="nt">&lt;ul</span> <span class="na">style=</span><span class="s">"padding: 0"</span><span class="nt">&gt;</span>
              @foreach ($product-&gt;reviews()-&gt;get() as $review)
                <span class="nt">&lt;li</span> <span class="na">style=</span><span class="s">"border-bottom: dotted 1px"</span><span class="nt">&gt;</span>
                  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"thumbnail__caption"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;h3</span> <span class="na">class=</span><span class="s">"text-xsmall text-overflow"</span> <span class="na">title=</span><span class="s">"{{ $review-&gt;nickname }}"</span><span class="nt">&gt;</span>
                      <span class="nt">&lt;span&gt;&lt;i</span> <span class="na">class=</span><span class="s">"text-xxsmall"</span> <span class="na">title=</span><span class="s">""</span><span class="nt">&gt;&lt;/i&gt;&lt;/span&gt;</span>{{ $review-&gt;nickname }}
                    <span class="nt">&lt;/h3&gt;</span>
                    <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"text-small"</span><span class="nt">&gt;</span>
<span class="hll">                      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"rating-star"</span><span class="nt">&gt;&lt;i</span> <span class="na">class=</span><span class="s">"star-actived rate-{{ $review-&gt;rate }}0"</span><span class="nt">&gt;&lt;/i&gt;&lt;/span&gt;</span>
</span>                    <span class="nt">&lt;/p&gt;</span>
                    <span class="nt">&lt;p&gt;</span>
                      {{ $review-&gt;review }}
                    <span class="nt">&lt;/p&gt;</span>
                  <span class="nt">&lt;/div&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
              @endforeach
            <span class="nt">&lt;/ul&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/article&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjSub"</span><span class="nt">&gt;</span>
@endsection
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">作品詳細ページで、星がきちんと表示されていることを確認しましょう。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/b102aef6d5e7bd258d36501bb09117e6.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//b102aef6d5e7bd258d36501bb09117e6.png"></p>

<h2 class="ng-scope" id="7">２．映画一覧ページでそれぞれの映画の平均評価を取得する</h2>

<p class="ng-scope">トップページに表示されている作品については、<strong>その作品についたレビュー全ての評価の平均</strong>を表示しましょう。</p>

<p class="ng-scope">平均値を求めるにはavg('カラム名')メソッドを使用します。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_403"></i> avgメソッド</h3>

<p class="ng-scope">avgメソッドは、avgメソッドを利用するインスタンス取得先のテーブルのカラムを引数にとります。その値の平均を、小数点ありの状態で返してくれます。<br>
例えば、生徒の得点を記録する<code>score</code>カラムを持った<code>students</code>テーブルと関連するStudentクラスがあったとします。scoreカラムの平均を求めるには、以下のようにします。</p>

<h3 class="ng-scope">【例】</h3>

<div class="code-frame ng-scope" data-lang="php"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="nv">$users</span> <span class="o">=</span> <span class="nx">Student</span><span class="o">::</span><span class="na">all</span><span class="p">();</span>
  <span class="nv">$users</span><span class="o">-&gt;</span><span class="na">avg</span><span class="p">(</span><span class="s1">'score'</span><span class="p">);</span>
  <span class="c1">// =&gt; 小数点まで含んだ平均点</span>
</pre></div>
</td>
</tr></tbody></table></div>

<h3 class="ng-scope">
<i class="icon information" id="term_404"></i> round()関数</h3>

<p class="ng-scope">round()関数はPHPに標準定義されている関数で、小数点ありの数字が利用できます。利用した数字の小数点以下を四捨五入します。</p>

<h3 class="ng-scope">【例】</h3>

<div class="code-frame ng-scope" data-lang="php"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="k">echo</span> <span class="nb">round</span><span class="p">(</span><span class="mf">10.4</span><span class="p">);</span>
  <span class="c1">// =&gt; 10</span>

  <span class="k">echo</span> <span class="nb">round</span><span class="p">(</span><span class="mf">10.7</span><span class="p">);</span>
  <span class="c1">// =&gt; 11</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">例えばトップページのビュー(index.blade.php)で以下のようにすると、各作品についてレビューの個数を取得することができますね。</p>

<div class="code-frame ng-scope" data-lang="rhtml"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td>
<td class="code">
<div class="highlight"><pre>  @foreach ($products as $product)
  //  （中略）
    {{ $product-&gt;reviews()-&gt;count() }}
  //  （中略）
  @endforeach
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">1.で作業した内容と似ていますが、今回foreach()関数を利用しているのは作品の配列です。作品の平均評価は、作品のインスタンスから直接取得することはできません。では、全ての評価の平均を表示するにはどうすれば良いでしょうか。</p>

<div class="challenge ng-scope">
  <h3>
<i class="icon crown"></i> 問題1：トップページで各作品の平均評価点を出しましょう</h3>
  <div class="challenge_box">
    <h5>作業ファイル：<br>resources/views/products/index.blade.php</h5>
    <h5>ヒント①：まずはプロダクトに関するレビュー全てを取得し、その後評価の平均を求めます</h5>
    【例】
     <div class="code-frame" data-lang="php"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td>
<td class="code">
<div class="highlight"><pre>    <span class="nx">ary</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nx">ary</span><span class="o">.</span><span class="nx">present</span><span class="o">?</span> <span class="c1">#=&gt; false</span>
</pre></div>
</td>
</tr></tbody></table></div>
    <curriculum-question-container data-order="1" class="ng-scope"><button class="answer ng-hide" ng-click="show_answer()" ng-show="isSolved">解答と解説を見る</button><button class="solve ng-binding" ng-click="solve()" ng-hide="isSolved">課題を解く</button><button class="solved ng-hide" ng-click="solved()" ng-show="isSolving">解けた</button>
</curriculum-question-container>
  </div>
</div>

<p class="ng-scope">作品一覧ページで星がきちんと表示されていることを確認しましょう。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/763155476af1438c0dd876c08377bd43.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//763155476af1438c0dd876c08377bd43.png"></p>

<h2 class="ng-scope" id="8">３．Product.phpにメソッドを定義する</h2>

<p class="ng-scope">2.までの作業で、productの平均評価を表示することができました。しかし、ビューファイルに長いロジックを書いてしまうとコードが読みづらくなってしまい、あとで管理が大変なので避けたほうが良いでしょう。そこで、この処理をまとめてメソッドにします。</p>

<p class="ng-scope">今回こちらのメソッドを利用しているのは<code>Productクラス</code>のインスタンスです。そこで、上記の処理は<code>Productクラス</code>の<strong>メソッド</strong>として定義します。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_405"></i> レシーバ</h3>

<p class="ng-scope">メソッドを利用するインスタンス自身のことです。例えば以下のようなコードがあった場合、10行目の式におけるレシーバは<code>book</code>です。</p>

<h3 class="ng-scope">【例】</h3>

<div class="code-frame ng-scope" data-lang="php"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Book</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">read</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">bookNum</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$book</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Book</span><span class="p">();</span>
<span class="nv">$book</span><span class="o">-&gt;</span><span class="na">read</span><span class="p">();</span>  <span class="c1">// レシーバはbook</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">上記の例では、レシーバである$bookが<code>read</code>メソッドの中で$thisに代入され、bookNumプロパティに5が代入されています。PHPの章(Lesson2)で扱っていた$thisはレシーバとも呼びます。</p>

<p class="ng-scope">今回<code>index.blade.php</code>に記述した処理をそのまま<code>Productクラス</code>に移動しただけではエラーが起きてしまいます。そこで、<code>$this</code>を利用しレシーバ自身である<code>product</code>をインスタンス・メソッドの中に呼んであげます。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> app/Product.phpを以下のように編集しましょう</h3>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">Product.php</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Product</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">reviews</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasMany</span><span class="p">(</span><span class="nx">Review</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>

<span class="hll">    <span class="k">public</span> <span class="k">function</span> <span class="nf">review_average</span><span class="p">()</span>
</span><span class="hll">    <span class="p">{</span>
</span><span class="hll">        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">reviews</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">avg</span><span class="p">(</span><span class="s1">'rate'</span><span class="p">));</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="p">}</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">続いて、定義したメソッドを実際にビューで利用します。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> resources/views/products/index.blade.phpを以下のように編集しましょう</h3>

<div class="code-frame ng-scope" data-lang="html">
<div class="code-lang"><span class="bold">resources/views/products/index.blade.php</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td>
<td class="code">
<div class="highlight"><pre>@extends('review_site')

@section('content')
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"main_cnt_wrapper"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjContentsBody"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"yjContainer"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"yjGuid"</span><span class="nt">&gt;&lt;a</span> <span class="na">id=</span><span class="s">"yjContentsStart"</span> <span class="na">name=</span><span class="s">"yjContentsStart"</span><span class="nt">&gt;&lt;/a&gt;&lt;img</span> <span class="na">alt=</span><span class="s">"ここから本文です"</span> <span class="na">height=</span><span class="s">"1"</span> <span class="na">src=</span><span class="s">"http://i.yimg.jp/yui/jp/tmpl/1.1.0/audionav.gif"</span> <span class="na">width=</span><span class="s">"1"</span><span class="nt">&gt;&lt;/span&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjMain"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;article</span> <span class="na">class=</span><span class="s">"section"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"header header--section"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;h2</span> <span class="na">class=</span><span class="s">"text-middle"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"icon-movie color-gray-light"</span><span class="nt">&gt;&lt;/i&gt;</span>新着作品
              <span class="nt">&lt;/h2&gt;</span>
            <span class="nt">&lt;/header&gt;</span>
            <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"thumbnails thumbnail--movies row grid4 js-lazy-load-images js-my-check-stats"</span> <span class="na">id=</span><span class="s">"list-module"</span><span class="nt">&gt;</span>
              @foreach ($products as $product)
                <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"col"</span><span class="nt">&gt;</span>
                  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/products/{{ $product-&gt;id }}"</span><span class="nt">&gt;&lt;div</span> <span class="na">class=</span><span class="s">"thumbnail__figure"</span> <span class="na">style=</span><span class="s">"background-image:url({{ $product-&gt;image_url }})"</span><span class="nt">&gt;&lt;/div&gt;&lt;/a&gt;</span>
                  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"thumbnail__caption"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;h3</span> <span class="na">class=</span><span class="s">"text-xsmall text-overflow"</span> <span class="na">title=</span><span class="s">"{{ $product-&gt;title }}"</span><span class="nt">&gt;</span>
                      {{ $product-&gt;title }}
                    <span class="nt">&lt;/h3&gt;</span>
                    <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"text-small"</span><span class="nt">&gt;</span>
                      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"rating-star"</span><span class="nt">&gt;</span>
<span class="hll">                        <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"star-actived rate-{{ $product-&gt;review_average() }}0"</span><span class="nt">&gt;&lt;/i&gt;</span>
</span>                      <span class="nt">&lt;/span&gt;</span>
                    <span class="nt">&lt;/p&gt;</span>
                  <span class="nt">&lt;/div&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
              @endforeach
            <span class="nt">&lt;/ul&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/article&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjSub"</span><span class="nt">&gt;</span>
@endsection
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">この段階で、2. の作業終了時と同じように平均の値が星の数で表示されていれば成功です。</p>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4237" class="ng-pristine ng-valid ng-scope">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-5908" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-5908" name="check-5908" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">トップページで作品の評価が星で表示された</span></label><!-- end ngRepeat: check in checkbox.checks --><label for="check-5909" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-5909" name="check-5909" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">作品ページでレビューの評価が星で表示された</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h1 class="ng-scope" id="9">STEP2：ランキング機能を実装しよう</h1>

<p class="ng-scope">次にランキング機能を実装しましょう。見本となるmoooviのサイトを確認してみてください。トップページの右側に<strong>投稿ランキング</strong>が表示されていると思います。</p>

<p class="ng-scope"><a href="https://app-mooovi.herokuapp.com/" target="_blank">mooovi(https://app-mooovi.herokuapp.com/)</a></p>

<p class="ng-scope"><img src="./応用機能の実装_files/17.png" alt="ランキング"></p>

<p class="ng-scope">このランキングは投稿数が多いものを上から順に<strong>トップ5</strong>で表示しています。ランキングを取得して表示させてみましょう。</p>

<h3 class="ng-scope">
<i class="icon dashboard"></i> 作業内容</h3>

<h5 class="ng-scope">1.__construct()メソッドを設定する</h5>

<h5 class="ng-scope">2.取得したproduct情報をビューに渡す</h5>

<h5 class="ng-scope">3.ランキングを表示させる</h5>

<h5 class="ng-scope">4.productsテーブルから、レビュー数が多い順に5件レコードを取得する</h5>

<h2 class="ng-scope" id="10">1.__construct()メソッドを設定する</h2>

<p class="ng-scope">ランキングの条件は<strong>「投稿数の多いものから順番に」</strong>と<strong>「上から5件取得」</strong>の2つです。ランキングが表示されるのは<strong>すべての画面</strong>です。つまり、<strong>すべてのコントローラーのアクションでランキングの情報を取得しなければなりません。</strong><br>
こういった場合、ランキングを取得する処理を<strong>__construct()メソッド</strong>で記述しましょう。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_407"></i> __construct()メソッド</h3>

<p class="ng-scope">あるコントローラのすべてのアクションで<strong>実行の前に共通の処理を行いたい</strong>ときがあります。<strong>construct()メソッドを使用すると全てのアクションが実行される前に</strong>construct()メソッド内に記述した内容を実行することができるようになります。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="php"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">コントローラ名</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// 処理</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">例えば、ProductsControllerという名前のコントローラで、毎回プロパティ<code>page_title</code>に「作品ページ」という文字列を代入する処理を各アクションの前に実行したいとします。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="php"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">ProductsController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
<span class="hll">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">page_title</span> <span class="o">=</span> <span class="s1">'作品ページ'</span><span class="p">;</span>
</span>    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">index</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$products</span> <span class="o">=</span> <span class="nx">Product</span><span class="o">::</span><span class="na">all</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">このソースコードではProductsControllerのindexアクションが呼ばれる前に、<code>__construct()</code>が実行されます。さらにindexアクションだけでなく、ProductsControllerの他すべてのアクションで<code>__construct()</code>が最初に呼ばれます。</p>

<p class="ng-scope"><strong>__construct()メソッドの特徴</strong><br>
① _<em>construct()を書いたコントローラのすべてのアクションの前に処理を行える<br>
② _</em>construct()を書いたコントローラで共通の処理を行える</p>

<p class="ng-scope">ではどのコントローラに<code>__construct()メソッド</code>を書けばいいでしょうか。今回ランキングを表示するのはいまのところは<strong>すべてのビューです。</strong>よって、<strong>ProductsController</strong>と<strong>ReviewsController</strong>の2つに書けばいいのですがこれら2つのコントローラは<strong>RankingControllerを継承しています</strong>。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_408"></i> コントローラの継承</h3>

<p class="ng-scope">コントローラは別のコントローラを<strong>継承</strong>することができます。継承をすると継承元のコントローラの持つメソッドや特徴を引き継ぐことができます。</p>

<p class="ng-scope">コントローラの継承はコントローラの定義で以下のように書きます。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="php"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">コントローラ</span> <span class="k">extends</span> <span class="nx">継承元のコントローラ</span>
<span class="p">}</span>
    <span class="c1">// 処理</span>
<span class="p">}</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">例えば、AnimalControllerを継承したDogControllerをつくる場合は以下のようになります。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="php"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">DogController</span> <span class="k">extends</span> <span class="nx">AnimalController</span>
<span class="p">{</span>
    <span class="c1">// 処理</span>
<span class="p">}</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">このとき、AnimalControllerで__construct()メソッドを以下のように定義しているとします。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="php"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">AnimalController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">"Hello Animal"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">すると、AnimalControllerを継承したDogControllerのすべてのアクションの前にも__construct()メソッドが呼ばれます。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="php"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">DogController</span> <span class="k">extends</span> <span class="nx">AnimalController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">show</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$dog</span> <span class="o">=</span> <span class="nx">Dog</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// =&gt; showアクションの前に__construct()が呼ばれる</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">すべてのコントローラで共通の__construct()を定義したい場合は<strong>Controllerクラス</strong>に記述します。<strong>これは、すべてのコントローラ</strong>(Controller以外)<strong>がControllerクラスを継承しているためです。</strong></p>

<p class="ng-scope">今回は<strong>RankingController</strong>にランキングを取得する__construct()メソッドを記述しましょう。<br>
RankingControllerを作らず直接Controllerクラスに記述すればいいのでは？、と思われるかもしれませんが、あくまでランキングを表示したいのはトップページと作品の個別ページです。この後マイページを実装していくのですが、Controllerクラスに記載するとマイページにもランキングが表示されてしまいます。よって、RankingControllerを作成し、ランキングを表示させたいReviewsControllerとProductsControllerを継承させています。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/f0f55e150adf0070541838f232bc5c8f.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//f0f55e150adf0070541838f232bc5c8f.png"></p>

<p class="ng-scope">「投稿数が多い順に」という部分はこのあと実装するので、今回はProductsテーブルに入ってる作品を5件取得してインスタンスごとのプロパティ<code>$productRanks</code>に入れておきましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> app/Http/Controllers/RankingController.phpを以下のように編集しましょう</h3>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">app/Http/Controllers/RankingController.php</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">App\Http\Controllers</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Http\Requests</span><span class="p">;</span>
<span class="hll"><span class="k">use</span> <span class="nx">App\Product</span><span class="p">;</span>
</span>
<span class="k">class</span> <span class="nc">RankingController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$layout</span> <span class="o">=</span> <span class="s2">"layouts.review_site"</span><span class="p">;</span>

<span class="hll">    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
</span><span class="hll">    <span class="p">{</span>
</span><span class="hll">        <span class="nv">$productRanks</span> <span class="o">=</span> <span class="nx">Product</span><span class="o">::</span><span class="na">take</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="p">}</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope"><code>take</code>メソッドも<code>orderBy</code>メソッドと同じように、<code>get</code>メソッドを必要とします。</p>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4238" class="ng-pristine ng-valid ng-scope">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-5910" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-5910" name="check-5910" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">__construct()メソッドを使って各アクション実行前にランキングプロパティを定義できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4239" class="ng-pristine ng-valid ng-scope">
  <h4 class="ng-binding">
    <i class="icon check_icon_00"></i>要点チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-5911" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-5911" name="check-5911" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">__construct()メソッドを設定するとコントローラーのアクションが呼ばれる前にメソッドを実行できる</span></label><!-- end ngRepeat: check in checkbox.checks --><label for="check-5912" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-5912" name="check-5912" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">コントローラーは他のコントローラーを継承できる</span></label><!-- end ngRepeat: check in checkbox.checks --><label for="check-5913" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-5913" name="check-5913" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">継承したコントローラは継承元のコントローラの__construct()メソッドやその他のメソッドを引き継いで使うことができる</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 class="ng-scope" id="11">2.取得したproduct情報をビューに渡す</h2>

<p class="ng-scope">1.でrankingプロパティにproductの情報を5件取得することができました。これらをランキング欄に表示させるためには、ビューにデータを渡す必要があります。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="php"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">return</span> <span class="nx">view</span><span class="p">(</span><span class="s1">'products.index'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">with</span><span class="p">(</span><span class="s1">'products'</span><span class="p">,</span> <span class="nv">$products</span><span class="p">);</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">上の例のようにこれまでは各コントローラーの各アクション内で変数を定義していましたが、今回はProductsControllerとReviewsControllerの全てのアクション内で$productRanksに格納されているデータをビューに渡す必要があります。<br>
これまで通りwithメソッドの引数に記述することも可能ですが、アクションが増える度に同じ記述を何度も書かないといけなくなり可読性が下がります。このような場合は<code>View::shareメソッド</code>を使うと簡潔に書くことが出来ます。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_409"></i> View::shareメソッド</h3>

<p class="ng-scope">View::shareメソッドはViewファサードに定義されているメソッドで、全てのビューで共通のデータを共有することが出来ます。以下のようにビューにデータを渡します。</p>

<div class="code-frame ng-scope" data-lang="php"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nx">View</span><span class="o">::</span><span class="na">share</span><span class="p">(</span><span class="s1">'ビュー内で使う変数名'</span><span class="p">,</span> <span class="nx">ビューに渡すデータ</span><span class="p">)</span>
</pre></div>
</td>
</tr></tbody></table></div>

<h3 class="ng-scope">
<i class="icon pen"></i> app/Http/Controllers/RankingController.phpを以下のように編集しましょう</h3>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">app/Http/Controllers/RankingController.php</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">App\Http\Controllers</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Http\Requests</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Product</span><span class="p">;</span>
<span class="hll"><span class="k">use</span> <span class="nx">View</span><span class="p">;</span>
</span>
<span class="k">class</span> <span class="nc">RankingController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$layout</span> <span class="o">=</span> <span class="s2">"layouts.review_site"</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$productRanks</span> <span class="o">=</span> <span class="nx">Product</span><span class="o">::</span><span class="na">take</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>

<span class="hll">        <span class="nx">View</span><span class="o">::</span><span class="na">share</span><span class="p">(</span><span class="s1">'ranking'</span><span class="p">,</span> <span class="nv">$productRanks</span><span class="p">);</span>
</span>    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">20行目のView::shareメソッドを追記しています。RankingControllerはProductsControllerとReviewsControllerの継承元のため、ProductsControllerとReviewsControllerに関する全てのビューにおいてranking変数が利用できるようになりました。</p>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4293" class="ng-pristine ng-valid ng-scope">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-5979" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-5979" name="check-5979" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">View::share()メソッドを用いてビューにランキングのデータを渡すことができた。</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4292" class="ng-pristine ng-valid ng-scope">
  <h4 class="ng-binding">
    <i class="icon check_icon_00"></i>要点チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-5978" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-5978" name="check-5978" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">複数のビューにおいて共通のデータを利用する場合は<code>View::share()メソッド</code>を使うと簡潔に書くことができる</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 class="ng-scope" id="12">3.ランキングを表示させる</h2>

<p class="ng-scope">では、先ほど定義したプロパティ<code>ranking</code>をビューに反映させましょう。どのファイルにランキングのHTMLが記述されているでしょうか。ランキングを表示するのはProductsControllerとReviewsControllerの全てのビューです。試しにviews/products/index.blade.phpファイルの冒頭部分を見てみましょう。</p>

<div class="code-frame ng-scope" data-lang="rhtml">
<div class="code-lang"><span class="bold">resources/views/products/index.blade.php</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="hll">@extends('layouts.review_site')
</span>
@section('content')
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"main_cnt_wrapper"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjContentsBody"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"yjContainer"</span><span class="nt">&gt;</span>
      // ...以下省略
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope"><code>@extends('layouts.review_site')</code>という記述がありますね。これはビューの<strong>レイアウトファイル</strong>を指定するものです。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_409"></i> レイアウトファイル</h3>

<p class="ng-scope">レイアウトファイルは各ページのベースとなるHTMLのことです。各bladeビューファイルはこのレイアウトファイルを継承しながら作成していきます。今回の例で言うと、ランキングは全てのビューにおいて表示されています。このようにどのページでも利用するHTMLはレイアウトファイルに記述し、共通化することができます。これにより、記述量が減らせたり、ビューファイルのカスタマイズの自由度が向上します。<br>
実は今まで修正してきたproductsやreviews配下のビューファイルは全てreview_siteレイアウトファイルを継承しています。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_410"></i> @extends('layouts.レイアウトファイル名')</h3>

<p class="ng-scope">各bladeビューファイルに@extends('レイアウトファイル名')とすると、そのビューファイル内で利用するレイアウトファイルを指定(継承)できます。<br>
<code>layouts.</code>となっているのはlayoutsディレクトリの中のレイアウトファイルを指定するという意味になります。必ずしもlayoutsディレクトリの中に格納する必要はありませんが、このほうがわかりやすいため本アプリケーションではlayoutsディレクトリに格納します。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="php"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="hll"><span class="o">@</span><span class="k">extends</span><span class="p">(</span><span class="s1">'layouts.movie'</span><span class="p">)</span>
</span>
<span class="o">@</span><span class="nx">section</span><span class="p">(</span><span class="s1">'content'</span><span class="p">)</span>
<span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"main_cnt_wrapper"</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"yjContentsBody"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">class</span><span class="o">=</span><span class="s2">"yjContainer"</span><span class="o">&gt;</span>
      <span class="c1">// ...以下省略</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">例えばこのように指定すると、表示されるレイアウトは<strong>movie.blade.php</strong>となります。</p>

<p class="ng-scope"><i class="icon attention"></i> なにも指定しないとレイアウトファイルは<strong>layout.blade.php</strong>となります。</p>

<hr class="ng-scope">

<p class="ng-scope">今回、RankingControllerでは<code>$layout = "layouts.review_site"</code>が指定されているので表示されるレイアウトファイルは<strong>review_site.blade.phpに</strong> なります。</p>

<p class="ng-scope">では<code>review_site.blade.php</code>を開いてみましょう。</p>

<ul class="filetree ng-scope">
  <li class="t-folder"> resources
    <ul>
      <li class="t-folder">layouts
        <ul>
          <li class="t-file"> review_site.blade.php
        </li>
</ul>
      </li>
    </ul>
  </li>
</ul>

<p class="ng-scope">review_site.blade.phpの29行目を見てみてください。</p>

<div class="code-frame ng-scope" data-lang="rhtml"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>29</pre></div></td>
<td class="code">
<div class="highlight"><pre>@yield('content')
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">この<code>@yield('content')</code>は外部のHTMLファイルを読み込むためのblade記法です。ここに今まで修正していたshow.blade.phpなどのHTMLがアクションごとに差し込まれます。</p>

<p class="ng-scope">もう一度views/products/index.blade.phpファイルを見てみましょう。</p>

<div class="code-frame ng-scope" data-lang="rhtml">
<div class="code-lang"><span class="bold">resources/views/products/index.blade.php</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td>
<td class="code">
<div class="highlight"><pre>@extends('layouts.review_site')

<span class="hll">@section('content')
</span><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"main_cnt_wrapper"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjContentsBody"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"yjContainer"</span><span class="nt">&gt;</span>
      // ...中略
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjSub"</span><span class="nt">&gt;</span>
@endsection
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope"><code>@section('content') ~ @endsection</code>で囲まれている部分に注目してください。このタグで囲まれている部分が<code>@yield('content')</code>に挿入するように指示しています。引数で指定している<code>content</code>はキーワードです。@yeildの引数contentと@sectionの引数contentが一致しているので挿入することができています。ですので一致さえすれば文字列ななんでも構いません。</p>

<p class="ng-scope">では、review_site.blade.phpを修正して、ランキングが表示されるようにしましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> resources/review_site.blade.phpを以下のように編集しましょう</h3>

<div class="code-frame ng-scope" data-lang="html">
<div class="code-lang"><span class="bold">review_site.blade.php</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">class=</span><span class="s">"pc"</span> <span class="na">lang=</span><span class="s">"ja"</span> <span class="na">xmlns:fb=</span><span class="s">"http://ogp.me/ns/fb#"</span> <span class="na">xmlns:og=</span><span class="s">"http://ogp.me/ns#"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;title&gt;</span>映画レビューサイト<span class="nt">&lt;/title&gt;</span>
      <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">'/css/review_site.css'</span> <span class="na">rel=</span><span class="s">'stylesheet'</span> <span class="na">type=</span><span class="s">'text/css'</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/meta&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body</span> <span class="na">class=</span><span class="s">"yj950-2"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"wrapper"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjContentsHeader"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">"globalnav"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"globalnav__menu"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"gmenu"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"logo"</span> <span class="na">style=</span><span class="s">"float: left"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/"</span><span class="nt">&gt;</span>mooovi<span class="nt">&lt;/a&gt;</span>
              <span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"entry_button"</span> <span class="na">style=</span><span class="s">"float: right"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/products/search"</span><span class="nt">&gt;</span>投稿する<span class="nt">&lt;/a&gt;</span>
              <span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;/ul&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/nav&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"bgcolor-white pt1em pb1em"</span> <span class="na">id=</span><span class="s">"contents"</span><span class="nt">&gt;</span>
        @yield('content')
        <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">"section"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;h4</span> <span class="na">class=</span><span class="s">"text-small hr-bottom--thin no-space-bottom"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"icon-crown color-gray-light"</span><span class="nt">&gt;&lt;/i&gt;</span>投稿ランキング
          <span class="nt">&lt;/h4&gt;</span>
          <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"listview listview--condensed text-small"</span><span class="nt">&gt;</span>
            {{-- */$i = 1/* --}}
<span class="hll">            @foreach ($ranking as $product)
</span>              <span class="nt">&lt;li</span> <span class="na">data-cinema-id=</span><span class="s">"346394"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/products/{{ $product-&gt;id }}"</span><span class="nt">&gt;</span>
                  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"box"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"box__cell w40 align-center"</span><span class="nt">&gt;</span>
                      <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"label bgcolor-gray-lighter align-center"</span><span class="nt">&gt;</span>
                        {{ $i }}
                      <span class="nt">&lt;/p&gt;</span>
                    <span class="nt">&lt;/div&gt;</span>
                    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"box__cell pl1em"</span><span class="nt">&gt;</span>
                      <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"text-xsmall no-space"</span><span class="nt">&gt;</span>
                        {{ $product-&gt;title }}
                      <span class="nt">&lt;/p&gt;</span>
                      <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"{{ $product-&gt;image_url }}"</span> <span class="na">alt=</span><span class="s">""</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;/div&gt;</span>
                  <span class="nt">&lt;/div&gt;</span>
                <span class="nt">&lt;/a&gt;</span>
              <span class="nt">&lt;/li&gt;</span>
              {{-- */$i++/* --}}
            @endforeach
          <span class="nt">&lt;/ul&gt;</span>
        <span class="nt">&lt;/aside&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>

        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"copyright"</span><span class="nt">&gt;</span>
          Copyright (C) 2015  XXX Corporation. All Rights Reserved.
        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">$rankingはEloquentORMのメソッドを利用して取得したデータのため、<code>Collection</code>クラスのインスタンスになっています。Collectionクラスの解説は後ほど行いますが、配列のメソッドを使うことができます。ランキングの変数<code>$ranking</code>に対して繰り返し処理を行って表示をしています。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/17.png" alt="ランキング"></p>

<p class="ng-scope">先ほど編集していただいた44行目の内容に、<strong>{{-- <em>/$i = 1/</em> --}}</strong> という記述がありました。こちらでは、$Iという変数に数字の1を代入して初期化しています。51行目で変数$Iを出力し、63行目で$Iに1を足す作業を行っています。そうすることで、要素の数だけforeachブロックを繰り返し実行し、繰り返しごとに <code>{{-- */$i++/* --}}</code> で$iに1が足されていきます。<br>
bladeテンプレート内で変数定義や自己代入演算子を使う場合は式を<code>{{-- */式/* --}}</code>で囲む必要があります。</p>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4240" class="ng-pristine ng-valid ng-scope">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-5914" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-5914" name="check-5914" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">ランキング画面にランキングを表示できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4241" class="ng-pristine ng-valid ng-scope">
  <h4 class="ng-binding">
    <i class="icon check_icon_00"></i>要点チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-5915" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-5915" name="check-5915" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">レイアウトファイルはURLにアクセスしたときに最初に呼ばれるHTMLファイル</span></label><!-- end ngRepeat: check in checkbox.checks --><label for="check-5916" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-5916" name="check-5916" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">コントローラで指定しないときに呼ばれるデフォルトのレイアウトファイルはlayout.blade.php</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 class="ng-scope" id="13">4.productsテーブルから、レビュー数が多い順に5件レコードを取得する</h2>

<p class="ng-scope">ReviewsControllerで取得したランキングの情報<code>ranking</code>は今はProductsテーブルから5件取得しているだけです。ランキングとして、レビューの投稿数が多い作品を5件取得しましょう。<br>
ここはEloquentORMを上手く使わないと実装できません。必要な処理は以下です。</p>

<p class="ng-scope"><strong>① Reviewsテーブルのレコードを<code>product_id</code>ごとにまとめて、数の多い5件を取得する</strong></p>

<p class="ng-scope"><strong>② 取得した5件のReviewsテーブルのproduct_idを取得する</strong></p>

<p class="ng-scope"><strong>③ 取得したproduct_id(5件分)と同値のidを持つproductsテーブルのレコードをそれぞれ取得する</strong></p>

<p class="ng-scope">①の「Reviewsテーブルのレコードを<code>product_id</code>ごとにまとめて、数の多い5件を取得する。」がもっとも難しい処理です。ここで考えてみましょう。Reviewモデルはどの作品のレビューかわかるようにカラムとして<code>product_id</code>を持っています。レビューの投稿数が多いとはつまり、<strong>product_idが同じReviewsテーブルのレコードの数が多い</strong>、ということになります。</p>

<p class="ng-scope">そこでまずは、Reviewsテーブルのレコードをproduct_idでまとめましょう。あるテーブルを特定のカラムでまとめるには<strong>groupBy</strong>メソッドを使います。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_411"></i> groupByメソッド</h3>

<p class="ng-scope">groupByメソッドはテーブルのレコードを<strong>指定したカラム</strong>でまとめることができます。以下のように使います。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="php"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nx">モデル</span><span class="o">::</span><span class="na">groupBy</span><span class="p">(</span><span class="nx">カラム名</span><span class="p">)</span>
<span class="nx">もしくは</span>
<span class="nx">モデル</span><span class="o">::</span><span class="na">他のメソッド</span><span class="o">-&gt;</span><span class="na">groupBy</span><span class="p">(</span><span class="nx">カラム名</span><span class="p">)</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">EloquentORMのメソッドはモデルに対して連結する場合は<code>::</code>を使い、メソッド同士を連結する場合は<code>-&gt;(アロー演算子)</code>を使います。</p>

<p class="ng-scope">groupByメソッドを使うと出力は以下のようになります。<br>
<code>eval(\Psy\sh());</code>で一度動作を止めて確認してみましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> RankingController.phpを以下のように編集しましょう</h3>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">RankingController.php</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">App\Http\Controllers</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Http\Requests</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Product</span><span class="p">;</span>
<span class="hll"><span class="k">use</span> <span class="nx">App\Review</span><span class="p">;</span>
</span><span class="k">use</span> <span class="nx">View</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">RankingController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$layout</span> <span class="o">=</span> <span class="s2">"layouts.review_site"</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$productRanks</span> <span class="o">=</span> <span class="nx">Product</span><span class="o">::</span><span class="na">take</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
<span class="hll">        <span class="nv">$reviews</span> <span class="o">=</span> <span class="nx">Review</span><span class="o">::</span><span class="na">groupBy</span><span class="p">(</span><span class="s1">'product_id'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</span>
<span class="hll">        <span class="k">eval</span><span class="p">(</span><span class="nx">\Psy\sh</span><span class="p">());</span>
</span>
        <span class="nx">View</span><span class="o">::</span><span class="na">share</span><span class="p">(</span><span class="s1">'ranking'</span><span class="p">,</span> <span class="nv">$productRanks</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">19行目のReview::groupBy('product_id')-&gt;get()で取得した値が$reviewsに格納されます。21行目の<code>eval(\Psy\sh());</code>で一度動作を止めています。ターミナルを見ると以下のようになっていると思います。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/6c0be16df563cdb6d5738da16b7b6368.png" alt="Psysh"></p>

<p class="ng-scope">これはコマンド入力待ちの状態になっていることを意味しています。今は$reviewsの中身を確認したいので、echo構文を使って変数の中身を出力してみましょう。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/3271914ae86b798d8e0a5be9190df0ff.png" alt="echo $reviews"></p>

<p class="ng-scope">echo $reviewsの中身が出力されたかと思います。<br>
<strong>日本語は\u9762\u767d\u304b\のように文字化けしますが気にしなくても大丈夫です</strong><br>
groupByメソッドを使うと、指定したカラムでレコードがまとめられます。まとめられたレコードの内、idが一番小さいレコードの１件だけが表示されていますが、プログラムが実行されている裏側ではすべてのレコードが指定したカラムでまとめられています。現在は、それぞれのまとまりが具体的に何個あるのかはわかりません。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/108191458f6c7e304a8f8e4d1f2aae9d.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//108191458f6c7e304a8f8e4d1f2aae9d.png"></p>

<p class="ng-scope">groupByメソッドでまとめられたレコードの数を取得したいです。ここは少し複雑ですが最終的に以下の例のような形になります。コンソールで1つ1つ試しながら動作を見ていきましょう。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">ターミナル</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre>Review::select<span class="o">(</span>DB::raw<span class="o">(</span><span class="s1">'count(*) as num, product_id'</span><span class="o">))</span>-&gt;groupBy<span class="o">(</span><span class="s1">'product_id'</span><span class="o">)</span>-&gt;orderBy<span class="o">(</span><span class="s1">'num'</span>, <span class="s1">'DESC'</span><span class="o">)</span>-&gt;get<span class="o">()</span><span class="p">;</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<h3 class="ng-scope">
<i class="icon pen"></i> ターミナルを以下のように実行しましょう</h3>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">ターミナル</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="err">$</span> <span class="nx">php</span> <span class="nx">artisan</span> <span class="nx">tinker</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">コンソールを使って確認していきます。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_413"></i> selectメソッド</h3>

<p class="ng-scope">selectメソッドはSQLのselect節から来ています。SQLについては学習していませんので、深く理解する必要はありませんが、参考までに以下の例を見てみましょう。</p>

<h3 class="ng-scope">[例]</h3>

<p class="ng-scope">以下の図ようにSequelProのヘッダー部分にはクエリというタブがあります。クエリタブを選択するとSQLというデータベースを操作するためのプログラムを書き込むことができます。<br>
<code>select * from reviews</code>と試しに入力してみましょう。<br>
<code>select</code>は<strong>データを取得するというSQLの文法</strong>を示しており、<code>＊</code>は<strong>全て</strong>という意味を表しています。<code>＊</code>のところには通常カラム名を指定しますが、<code>＊</code>を指定した場合全てのカラムを指定したことになります。続く<code>from</code>は<strong>どのテーブルからデータを取得するか</strong>を指定します。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/11ba40e27e069b29c606095f7f7fe7ae.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//11ba40e27e069b29c606095f7f7fe7ae.png"></p>

<p class="ng-scope">従ってreviewsテーブルから全てのカラムの情報を取得するという意味になります。<br>
最後に「現在を実行」ボタンを押すと、取得したデータを表示することができます。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/16fc1123dc9cab7345346ed455e7b71c.png" alt="現在を実行"></p>

<p class="ng-scope">selectの後には<code>*</code>を指定し、全てのカラムを取得しました。これと同じように、selectメソッドは取得するカラム名を指定することができます。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">コンソール</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td>
<td class="code">
<div class="highlight"><pre>&gt;&gt;&gt; App<span class="se">\R</span>eview::select<span class="o">(</span><span class="s1">'*'</span><span class="o">)</span>-&gt;get<span class="o">()</span><span class="p">;</span>

<span class="o">=</span>&gt; Illuminate<span class="se">\D</span>atabase<span class="se">\E</span>loquent<span class="se">\C</span>ollection <span class="o">{</span><span class="c">#651</span>
     all: <span class="o">[</span>
       App<span class="se">\R</span>eview <span class="o">{</span><span class="c">#652</span>
         id: 1,
         nickname: <span class="s2">"kondo"</span>,
         rate: 6,
         review: <span class="s2">"This movie is interesting!!!"</span>,
         product_id: 5,
         created_at: <span class="s2">"2016-10-30 09:06:16"</span>,
         updated_at: <span class="s2">"2016-10-30 09:06:16"</span>,
       <span class="o">}</span>,
       App<span class="se">\R</span>eview <span class="o">{</span><span class="c">#653</span>
         id: 2,
         nickname: <span class="s2">"tanaka"</span>,
         rate: 1,
         review: <span class="s2">"Thank you."</span>,
         product_id: 1,
         created_at: <span class="s2">"2016-10-30 09:07:09"</span>,
         updated_at: <span class="s2">"2016-10-30 09:07:09"</span>,
       <span class="o">}</span>,
      // 以下省略
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">selectメソッドの引数に<code>＊</code>を指定すると、先ほどSequelProに<strong>select * from reviews</strong>を指定して取得したデータと同じデータが取得できます。</p>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">コンソール</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td>
<td class="code">
<div class="highlight"><pre>&gt;&gt;&gt; App<span class="se">\R</span>eview::select<span class="o">(</span><span class="s1">'product_id'</span><span class="o">)</span>-&gt;get<span class="o">()</span><span class="p">;</span>

<span class="o">=</span>&gt; Illuminate<span class="se">\D</span>atabase<span class="se">\E</span>loquent<span class="se">\C</span>ollection <span class="o">{</span><span class="c">#659</span>
     all: <span class="o">[</span>
       App<span class="se">\R</span>eview <span class="o">{</span><span class="c">#660</span>
         product_id: 5,
       <span class="o">}</span>,
       App<span class="se">\R</span>eview <span class="o">{</span><span class="c">#661</span>
         product_id: 1,
       <span class="o">}</span>,
       App<span class="se">\R</span>eview <span class="o">{</span><span class="c">#662</span>
         product_id: 6,
       <span class="o">}</span>,
       App<span class="se">\R</span>eview <span class="o">{</span><span class="c">#663</span>
         product_id: 5,
       <span class="o">}</span>,
       App<span class="se">\R</span>eview <span class="o">{</span><span class="c">#664</span>
         product_id: 3,
       <span class="o">}</span>,
     <span class="o">]</span>,
   <span class="o">}</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">次に全てのカラムではなくproduct_idのみを取得しました。product_idが5の値が複数存在します。同じ値のものはまとめてカウントできるようにしましょう。カラムでまとめるためには先ほど学習したgroupByメソッドを使います。</p>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">ターミナル</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td>
<td class="code">
<div class="highlight"><pre>&gt;&gt;&gt; App<span class="se">\R</span>eview::select<span class="o">(</span><span class="s1">'product_id'</span><span class="o">)</span>-&gt;groupBy<span class="o">(</span><span class="s1">'product_id'</span><span class="o">)</span>-&gt;get<span class="o">()</span><span class="p">;</span>

<span class="o">=</span>&gt; Illuminate<span class="se">\D</span>atabase<span class="se">\E</span>loquent<span class="se">\C</span>ollection <span class="o">{</span><span class="c">#649</span>
     all: <span class="o">[</span>
       App<span class="se">\R</span>eview <span class="o">{</span><span class="c">#648</span>
         product_id: 1,
       <span class="o">}</span>,
       App<span class="se">\R</span>eview <span class="o">{</span><span class="c">#638</span>
         product_id: 3,
       <span class="o">}</span>,
       App<span class="se">\R</span>eview <span class="o">{</span><span class="c">#645</span>
         product_id: 5,
       <span class="o">}</span>,
       App<span class="se">\R</span>eview <span class="o">{</span><span class="c">#665</span>
         product_id: 6,
       <span class="o">}</span>,
     <span class="o">]</span>,
   <span class="o">}</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">カラムでグルーピングし重複をなくすことができました。また、product_id順にデータが並んでいるのがわかります。ランキングでソートするためには、各product_idのreviewが何個存在するかを数える必要があります。product_idでまとめたレコードの数でソートするには以下のようにSQLの <em>count関数</em>と <em>as句</em> を使います。</p>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">コンソール</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nx">Review</span><span class="o">::</span><span class="na">select</span><span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="nx">num</span><span class="p">,</span> <span class="nx">product_id</span><span class="p">)</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">しかし、selectメソッドの引数にSQLプログラムを直接書くことができません。そこで登場するのが <code>DB::rawメソッド</code> です。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_413"></i> DB::rawメソッド</h3>

<p class="ng-scope">DB::rawメソッドはSQLプログラムを直接記述したい場合に使います。DB::rawメソッドの引数にSQLプログラムを書くことでSQLを実行することができます。今回の場合、count関数やas句などがSQLの文法に当たります。また、<code>use DB;</code>としてDBクラスをインクルードする必要があります。</p>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">コンソール</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="nx">App\Review</span><span class="o">::</span><span class="na">select</span><span class="p">(</span><span class="nx">DB</span><span class="o">::</span><span class="na">raw</span><span class="p">(</span><span class="s1">'count(*) as num, product_id'</span><span class="p">))</span><span class="o">-&gt;</span><span class="na">groupBy</span><span class="p">(</span><span class="s1">'product_id'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">count関数は引数にカラム名を指定するとそのカラム名の値が存在するレコードの件数を返してくれます。as句はカラム名に別名を付けることができます。従って、count(*)で取得した値をnumという名前で表示するという意味になります。第二引数にはproduct_idカラムを指定しています。</p>

<p class="ng-scope">これでそれぞれのproduct_idに紐付いたnumの値(reviewsテーブルのレコード数)が取得できました。次にレビューの投稿が多い順に並べましょう。並び替えはorderByメソッドを使うのでした。numはレビューの数を示しているのでnumが多い順に並べ替えれば良さそうです。</p>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">コンソール</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="nx">App\Review</span><span class="o">::</span><span class="na">select</span><span class="p">(</span><span class="nx">DB</span><span class="o">::</span><span class="na">raw</span><span class="p">(</span><span class="s1">'count(*) as num, product_id'</span><span class="p">))</span><span class="o">-&gt;</span><span class="na">groupBy</span><span class="p">(</span><span class="s1">'product_id'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">orderBy</span><span class="p">(</span><span class="s1">'num'</span><span class="p">,</span> <span class="s1">'DESC'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>

<span class="o">=&gt;</span> <span class="nx">Illuminate\Database\Eloquent\Collection</span> <span class="p">{</span><span class="c1">#670</span>
     <span class="nx">all</span><span class="o">:</span> <span class="p">[</span>
       <span class="nx">App\Review</span> <span class="p">{</span><span class="c1">#671</span>
         <span class="nx">num</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
         <span class="nx">product_id</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
       <span class="p">},</span>
       <span class="nx">App\Review</span> <span class="p">{</span><span class="c1">#672</span>
         <span class="nx">num</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
         <span class="nx">product_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
       <span class="p">},</span>
       <span class="nx">App\Review</span> <span class="p">{</span><span class="c1">#673</span>
         <span class="nx">num</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
         <span class="nx">product_id</span><span class="o">:</span> <span class="mi">6</span><span class="p">,</span>
       <span class="p">},</span>
       <span class="nx">App\Review</span> <span class="p">{</span><span class="c1">#674</span>
         <span class="nx">num</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
         <span class="nx">product_id</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
       <span class="p">},</span>
     <span class="p">],</span>
   <span class="p">}</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">最後に、取得したいのは5件なので<code>take(5)</code>を付け加えます。</p>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">コンソール</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nx">App\Review</span><span class="o">::</span><span class="na">select</span><span class="p">(</span><span class="nx">DB</span><span class="o">::</span><span class="na">raw</span><span class="p">(</span><span class="s1">'count(*) as num, product_id'</span><span class="p">))</span><span class="o">-&gt;</span><span class="na">groupBy</span><span class="p">(</span><span class="s1">'product_id'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">orderBy</span><span class="p">(</span><span class="s1">'num'</span><span class="p">,</span> <span class="s1">'DESC'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">take</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">以上でproduct_idの配列を投稿数が多い順に取得できました。</p>

<hr class="ng-scope">

<p class="ng-scope">numとproduct_idをキーに持つインスタンス情報が入っている配列からidに該当するProductsテーブルのレコードを取得するにはどうすればいいでしょうか。</p>

<p class="ng-scope">まず、思いつくのは<strong>where</strong>メソッドですね。whereメソッドはカラムと値を指定して、指定した値のカラムを持つレコードを取得します。ただし、配列を指定する場合は<strong>whereInメソッド</strong>を使います。Productsテーブルのidの配列<code>ids</code>を使ってwhereInしてみます。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">コンソール</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="o">&gt;&gt;&gt;</span> <span class="nv">$ids</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span> <span class="c1"># Productsテーブルのidの配列</span>
  <span class="o">&gt;&gt;&gt;</span> <span class="nv">$products</span> <span class="o">=</span> <span class="nx">App\Product</span><span class="o">::</span><span class="na">whereIn</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="nv">$ids</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
<span class="o">=&gt;</span> <span class="nx">Illuminate\Database\Eloquent\Collection</span> <span class="p">{</span><span class="c1">#666</span>
     <span class="nx">all</span><span class="o">:</span> <span class="p">[</span>
       <span class="nx">App\Product</span> <span class="p">{</span><span class="c1">#671</span>
         <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
         <span class="nx">title</span><span class="o">:</span> <span class="s2">"オオカミ少女と黒王子"</span><span class="p">,</span>
         <span class="nx">image_url</span><span class="o">:</span> <span class="s2">"http://image.eiga.k-img.com/images/movie/82939/poster2/200.jpg?1456105504"</span><span class="p">,</span>
         <span class="nx">created_at</span><span class="o">:</span> <span class="s2">"2016-10-30 08:52:56"</span><span class="p">,</span>
         <span class="nx">updated_at</span><span class="o">:</span> <span class="s2">"2016-10-30 08:52:56"</span><span class="p">,</span>
         <span class="nx">director</span><span class="o">:</span> <span class="s2">"廣木隆一 "</span><span class="p">,</span>
         <span class="nx">detail</span><span class="o">:</span> <span class="nx">省略</span><span class="p">,</span>
         <span class="nx">open_date</span><span class="o">:</span> <span class="s2">"2016年5月28日 "</span><span class="p">,</span>
       <span class="p">},</span>
       <span class="nx">App\Product</span> <span class="p">{</span><span class="c1">#672</span>
         <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
         <span class="nx">title</span><span class="o">:</span> <span class="s2">"ヒメアノ～ル"</span><span class="p">,</span>
         <span class="nx">image_url</span><span class="o">:</span> <span class="s2">"http://image.eiga.k-img.com/images/movie/82031/200x133.jpg?1458617968"</span><span class="p">,</span>
         <span class="nx">created_at</span><span class="o">:</span> <span class="s2">"2016-10-30 08:52:57"</span><span class="p">,</span>
         <span class="nx">updated_at</span><span class="o">:</span> <span class="s2">"2016-10-30 08:52:57"</span><span class="p">,</span>
         <span class="nx">director</span><span class="o">:</span> <span class="s2">"吉田恵輔 "</span><span class="p">,</span>
         <span class="nx">detail</span><span class="o">:</span> <span class="nx">省略</span><span class="p">,</span>
       <span class="p">},</span>
   <span class="c1">// 以下省略</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">これで該当するidの値がすべて取得できました。<br>
しかし、ここで１つ問題があります。それは<strong>取得したレコードの順番</strong>です。<br>
以下のような配列<code>$ids</code>でwhereInしたとき、レコードはどのような順番で取得できるでしょうか。</p>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">コンソール</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="o">&gt;&gt;&gt;</span> <span class="nv">$ids</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span> <span class="c1"># Productsテーブルのidの配列</span>
  <span class="o">&gt;&gt;&gt;</span> <span class="nv">$products</span> <span class="o">=</span> <span class="nx">App\Product</span><span class="o">::</span><span class="na">whereIn</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="nv">$ids</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
  <span class="o">=&gt;</span> <span class="nx">Illuminate\Database\Eloquent\Collection</span> <span class="p">{</span><span class="c1">#666</span>
     <span class="nx">all</span><span class="o">:</span> <span class="p">[</span>
       <span class="nx">App\Product</span> <span class="p">{</span><span class="c1">#671</span>
         <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
         <span class="nx">title</span><span class="o">:</span> <span class="s2">"オオカミ少女と黒王子"</span><span class="p">,</span>
         <span class="nx">image_url</span><span class="o">:</span> <span class="s2">"http://image.eiga.k-img.com/images/movie/82939/poster2/200.jpg?1456105504"</span><span class="p">,</span>
         <span class="nx">created_at</span><span class="o">:</span> <span class="s2">"2016-10-30 08:52:56"</span><span class="p">,</span>
         <span class="nx">updated_at</span><span class="o">:</span> <span class="s2">"2016-10-30 08:52:56"</span><span class="p">,</span>
         <span class="nx">director</span><span class="o">:</span> <span class="s2">"廣木隆一 "</span><span class="p">,</span>
         <span class="nx">detail</span><span class="o">:</span> <span class="nx">省略</span><span class="p">,</span>
         <span class="nx">open_date</span><span class="o">:</span> <span class="s2">"2016年5月28日 "</span><span class="p">,</span>
       <span class="p">},</span>
       <span class="nx">App\Product</span> <span class="p">{</span><span class="c1">#672</span>
         <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
         <span class="nx">title</span><span class="o">:</span> <span class="s2">"ヒメアノ～ル"</span><span class="p">,</span>
         <span class="nx">image_url</span><span class="o">:</span> <span class="s2">"http://image.eiga.k-img.com/images/movie/82031/200x133.jpg?1458617968"</span><span class="p">,</span>
         <span class="nx">created_at</span><span class="o">:</span> <span class="s2">"2016-10-30 08:52:57"</span><span class="p">,</span>
         <span class="nx">updated_at</span><span class="o">:</span> <span class="s2">"2016-10-30 08:52:57"</span><span class="p">,</span>
         <span class="nx">director</span><span class="o">:</span> <span class="s2">"吉田恵輔 "</span><span class="p">,</span>
         <span class="nx">detail</span><span class="o">:</span> <span class="nx">省略</span><span class="p">,</span>
       <span class="p">},</span>
   <span class="c1">// 以下省略</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">出力結果に注目してください。配列<code>$ids</code>を上の<code>$ids = array(1, 2, 3)</code>とした場合と、いまの<code>$ids = array(3, 1, 2)</code>の出力結果は同じです。これはwhereInで値を配列にした場合、<strong>並びがid順になってしまう</strong>ためです。</p>

<p class="ng-scope">せっかくProductモデルのidをレビューの投稿が多い順に取得したのに、これでは意味がありません。</p>

<ul class="ng-scope">
<li>期待した出力結果</li>
</ul>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="o">=</span>&gt; <span class="o">[{</span><span class="s2">"id"</span>:3,<span class="s2">"title"</span>: ~~ 省略<span class="o">}</span>,
         <span class="o">{</span><span class="s2">"id"</span>:1,<span class="s2">"title"</span>: ~~ 省略<span class="o">}</span>,
         <span class="o">{</span><span class="s2">"id"</span>:2,<span class="s2">"title"</span>: ~~ 省略<span class="o">}]</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<ul class="ng-scope">
<li>whereInメソッドでの出力結果</li>
</ul>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="o">=</span>&gt; <span class="o">[{</span><span class="s2">"id"</span>:1,<span class="s2">"title"</span>: ~~ 省略<span class="o">}</span>,
         <span class="o">{</span><span class="s2">"id"</span>:2,<span class="s2">"title"</span>: ~~ 省略<span class="o">}</span>,
         <span class="o">{</span><span class="s2">"id"</span>:3,<span class="s2">"title"</span>: ~~ 省略<span class="o">}]</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">この問題を解決するために<strong>mapメソッド</strong>を使用します。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_415"></i> mapメソッド</h3>

<p class="ng-scope">mapメソッドはCollectionクラスのインスタンスに対して利用できるメソッドです。EloquentORMのメソッドを使ってデータベースから値を取得した場合、それらは全てCollectionクラスのインスタンスとなります。mapメソッドはCollectionインスタンスの中身を1つずつ取り出して処理を行います。そして中身を並べ替えた新しいインスタンスを生成します。</p>

<p class="ng-scope">mapメソッドは以下のように使用します。</p>

<div class="code-frame ng-scope" data-lang="php"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nx">Collectionインスタンス</span><span class="o">-&gt;</span><span class="na">map</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="nv">$ele</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// 処理</span>
<span class="p">}</span>

  <span class="c1">// $eleには配列の要素が１つずつ代入される</span>
  <span class="c1">// 関数内の処理は配列の要素の数だけ繰り返し実行される</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">具体的な例を見ていきましょう。<br>
配列に入っている全ての数値を2乗した新しい配列を取得したい場合、mapメソッドを使うと以下のように書けます。mapメソッドを使うには配列をcollect()で覆うことでCollectionインスタンスに変換できます。</p>

<h3 class="ng-scope">【例】</h3>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">コンソール</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="nv">$numbers</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<span class="o">=&gt;</span> <span class="p">[</span>
     <span class="mi">3</span><span class="p">,</span>
     <span class="mi">1</span><span class="p">,</span>
     <span class="mi">2</span><span class="p">,</span>
   <span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nv">$squares</span> <span class="o">=</span> <span class="nx">collect</span><span class="p">(</span><span class="nv">$numbers</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">map</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="nv">$num</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nv">$num</span> <span class="o">*</span> <span class="nv">$num</span><span class="p">;</span> <span class="p">});</span>
<span class="o">=&gt;</span> <span class="nx">Illuminate\Support\Collection</span> <span class="p">{</span><span class="c1">#653</span>
     <span class="nx">all</span><span class="o">:</span> <span class="p">[</span>
       <span class="mi">9</span><span class="p">,</span>
       <span class="mi">1</span><span class="p">,</span>
       <span class="mi">4</span><span class="p">,</span>
     <span class="p">],</span>
   <span class="p">}</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">ちゃんと配列<code>$numbers</code>の各値が2乗された数値が<code>$squares</code>に代入されています。</p>

<p class="ng-scope">これはmapメソッドによって以下のように処理が行われたためです。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/47.png" alt="mapメソッド"></p>

<p class="ng-scope">mapメソッドを使うとCollectionインスタンスの各要素を使って新しいCollectionインスタンスを生成することができます。numとproduct_idを保持したCollectionインスタンスに対してmapメソッドを使い、Productsテーブルからレコードを取得するのは以下のような方法になります。</p>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="nv">$reviewSort</span> <span class="o">=</span>  <span class="o">[{</span><span class="s2">"num"</span>:2,<span class="s2">"product_id"</span>:5<span class="o">}</span>,<span class="o">{</span><span class="s2">"num"</span>:1,<span class="s2">"product_id"</span>:1<span class="o">}</span>,<span class="o">{</span><span class="s2">"num"</span>:1,<span class="s2">"product_id"</span>:6<span class="o">}</span>,<span class="o">{</span><span class="s2">"num"</span>:1,<span class="s2">"product_id"</span>:3<span class="o">}]</span> <span class="c"># Reviewsテーブルのnumとproduct_idのCollectionインスタンス</span>
  <span class="nv">products</span> <span class="o">=</span> <span class="nv">$reviewSort</span>-&gt;map<span class="o">(</span><span class="k">function</span><span class="o">(</span><span class="nv">$review</span><span class="o">)</span> <span class="o">{</span> productsテーブルからidがproduct_idのレコードを取得する <span class="o">})</span>
  <span class="o">=</span>&gt; productsテーブルのレコードが入った配列
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">mapメソッドを使うと順番はそのままでProductsテーブルからレコードを取得することができます。こちらのブロックの処理ではfindメソッドを使い、Productsテーブルからidがproduct_idのレコードを一本ずつ取得しましょう。</p>

<p class="ng-scope">では、これらをヒントにランキング機能を実装しましょう。</p>

<div class="challenge ng-scope">
  <h3>
<i class="icon crown"></i> 問題2：レビューの投稿が多い作品を上から順に5件取得し、ランキングの変数$productRanksに代入しましょう</h3>
  <div class="challenge_box">
    <h5>作業ファイル：app/Http/Controllers/RankingController.php </h5>
    <h5>ヒント①：まず、レビュー数の多いproductのid上位5つが、多い順に並んだ配列を用意します</h5>
    <h5>ヒント②：次にmapメソッドを利用し、Collectionインスタンスの中身をProductクラスのインスタンスに変換します</h5>

    <curriculum-question-container data-order="2" class="ng-scope"><button class="answer ng-hide" ng-click="show_answer()" ng-show="isSolved">解答と解説を見る</button><button class="solve ng-binding" ng-click="solve()" ng-hide="isSolved">課題を解く</button><button class="solved ng-hide" ng-click="solved()" ng-show="isSolving">解けた</button>
</curriculum-question-container>
  </div>
</div>

<p class="ng-scope">画面右側に、ランキング機能が実装されていることを確認ましょう。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/eb05322750fe784cf7500850e5fed7d8.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//eb05322750fe784cf7500850e5fed7d8.png"></p>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4242" class="ng-pristine ng-valid ng-scope">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-5917" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-5917" name="check-5917" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">レビューの投稿が多い順にランキングを表示できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4297" class="ng-pristine ng-valid ng-scope">
  <h4 class="ng-binding">
    <i class="icon check_icon_00"></i>要点チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-5987" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-5987" name="check-5987" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding"><strong>groupBy()メソッド</strong>を使うと指定したカラムでレコードをまとめることができる</span></label><!-- end ngRepeat: check in checkbox.checks --><label for="check-5988" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-5988" name="check-5988" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding"><strong>DB::raw()メソッド</strong>を使うことでSQLプログラムを直接記述することができる</span></label><!-- end ngRepeat: check in checkbox.checks --><label for="check-5989" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-5989" name="check-5989" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">SQLの<strong>count('カラム名')関数</strong>はカラム名の値が存在するレコードの件数を返してくれる</span></label><!-- end ngRepeat: check in checkbox.checks --><label for="check-5990" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-5990" name="check-5990" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding"> <strong>map()メソッド</strong>は配列の中身を1つずつ処理し、新しいインスタンスを生成する</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h1 class="ng-scope" id="14">STEP3：ユーザーのサインアップ画面をつくろう</h1>

<p class="ng-scope">いまのmoooviにはユーザーという概念がありません。自分で書いたレビューをあとで見られるように、サインアップ画面をつくってユーザーを生成するようにしましょう。</p>

<h3 class="ng-scope">
<i class="icon dashboard"></i> 作業内容</h3>

<h5 class="ng-scope">1.viewファイルを作成する</h5>

<h5 class="ng-scope">2.必要なファイルを入れ替える</h5>

<h2 class="ng-scope" id="15">1.viewファイルを作成</h2>

<p class="ng-scope">Laravelではユーザー周りの機能がデフォルトで大部分が実装されています。しかしViewファイルは自分で作る必要があります。<code>php artisan make:auth</code>コマンドを使うとviewファイルが自動生成されます。</p>

<h3 class="ng-scope">
<i class="icon pen" id="41"></i> 以下のコマンドを実行しましょう</h3>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">ターミナル</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="nv">$ </span>php artisan make:auth
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">以下のファイルが生成されます。</p>

<ul class="ng-scope">
<li><strong>resources/views/auth/login.blade.php</strong></li>
<li><strong>resources/views/auth/register.blade.php</strong></li>
<li><strong>resources/views/auth/passwords/email.blade.php</strong></li>
<li><strong>resources/views/auth/passwords/reset.blade.php</strong></li>
<li><strong>resources/views/auth/emails/password.blade.php</strong></li>
<li><strong>resources/views/layouts/app.blade.php</strong></li>
<li><strong>resources/views/home.blade.php</strong></li>
<li><strong>resources/views/welcome.blade.php</strong></li>
<li><strong>app/Http/Controllers/HomeController.php</strong></li>
</ul>

<p class="ng-scope">今回使うのは新規登録・ログイン周りのビューファイルのみです。必要のないファイルは削除しましょう。</p>

<h3 class="ng-scope">
<i class="icon pen" id="41"></i> 以下のファイルとルーティングを削除しましょう</h3>

<p class="ng-scope">以下のファイルを削除<br>
- <strong>resources/views/layouts/app.blade.php</strong><br>
- <strong>resources/views/home.blade.php</strong><br>
- <strong>resources/views/welcome.blade.php</strong><br>
- <strong>app/Http/Controllers/HomeController.php</strong></p>

<p class="ng-scope">以下のルーティングを削除</p>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">routes.php</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">'/home'</span><span class="p">,</span> <span class="s1">'HomeController@index'</span><span class="p">);</span>  <span class="c1">// この1行を削除</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<h3 class="ng-scope">
<i class="icon pen" id="41"></i> ルーティングを以下のように編集しましょう</h3>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">routes.php</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nx">Route</span><span class="o">::</span><span class="na">group</span><span class="p">([</span><span class="s1">'middleware'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'web'</span><span class="p">]],</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="s1">'ProductsController@index'</span><span class="p">);</span>
    <span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">'/products/search/'</span><span class="p">,</span> <span class="s1">'ProductsController@search'</span><span class="p">);</span>
    <span class="nx">Route</span><span class="o">::</span><span class="na">resource</span><span class="p">(</span><span class="s1">'products'</span><span class="p">,</span> <span class="s1">'ProductsController'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'only'</span> <span class="o">=&gt;</span> <span class="s1">'show'</span><span class="p">]);</span>
    <span class="nx">Route</span><span class="o">::</span><span class="na">resource</span><span class="p">(</span><span class="s1">'products.reviews'</span><span class="p">,</span> <span class="s1">'ReviewsController'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'only'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'create'</span><span class="p">,</span> <span class="s1">'store'</span><span class="p">]]);</span>
<span class="hll">    <span class="nx">Route</span><span class="o">::</span><span class="na">auth</span><span class="p">();</span>
</span><span class="p">});</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">php artisan make:authコマンドで<code>Route::auth();</code>ルートが生成されます。これを7行目の位置に移動させてください。</p>

<h2 class="ng-scope" id="16">2.必要なファイルを入れ替える</h2>

<p class="ng-scope">php artisan auth:makeコマンドで生成されるファイルのうち2つのファイルを準備のときにダウンロードした<strong>Laravel2-4フォルダ</strong>にあるファイルと置き換えましょう。</p>

<p class="ng-scope">ダウンロードしたフォルダを消してしまった人は以下のリンクからもう一度ダウンロードしてください。</p>

<p class="ng-scope"><a href="https://www.dropbox.com/s/o0hmrc58h7co705/Laravel2-4.zip?dl=1" target="_blank">Laravel2-4.zip</a></p>

<p class="ng-scope">置き換えるファイルは以下の2つのファイルです。</p>

<ul class="ng-scope">
<li><strong>resources/views/auth/login.blade.php</strong></li>
<li><strong>resources/views/auth/register.blade.php</strong></li>
</ul>

<h3 class="ng-scope">
<i class="icon pen"></i> authディレクトリにあるlogin.html.erbファイルをダウンロードしたファイルで置き換えましょう</h3>

<p class="ng-scope"><strong>削除するファイル(mooovi)</strong></p>

<ul class="filetree ng-scope">
  <li class="t-folder"> resources
    <ul>
      <li class="t-folder"> views
        <ul>
          <li class="t-folder"> auth
            <ul>
              <li class="t-file"> <strong>login.blade.php</strong> </li>
              </ul>
</li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  


<p class="ng-scope"><strong>新しく置き換えるファイル(ダウンロードしたLaravel2-4)</strong></p>

<ul class="filetree ng-scope">
  <li class="t-folder"> Laravel2-4
    <ul>
          <li class="t-folder"> auth
            <ul>
            <li class="t-file"> <strong>login.blade.php</strong> </li>
            </ul>
    </li>
</ul>
  </li>
</ul>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4298" class="ng-pristine ng-valid ng-scope">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-5991" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-5991" name="check-5991" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding"><strong>resources/views/auth/login.blade.php</strong>を置き換えることができた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h3 class="ng-scope">
<i class="icon pen"></i> authディレクトリにあるregister.blade.phpファイルをダウンロードしたファイルで置き換えましょう</h3>

<p class="ng-scope"><strong>削除するファイル(mooovi)</strong></p>

<ul class="filetree ng-scope">
  <li class="t-folder"> resources
    <ul>
      <li class="t-folder"> views
        <ul>
          <li class="t-folder"> auth
            <ul>
              <li class="t-file"> <strong>register.blade.php</strong> </li>
              </ul>
</li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  


<p class="ng-scope"><strong>新しく置き換えるファイル(ダウンロードしたLaravel2-4)</strong></p>

<ul class="filetree ng-scope">
  <li class="t-folder"> Laravel2-4
    <ul>
          <li class="t-folder"> auth
            <ul>
            <li class="t-file"> <strong>register.blade.php</strong>
</li>
            </ul>
    </li>
</ul>
  </li>
</ul>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4299" class="ng-pristine ng-valid ng-scope">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-5992" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-5992" name="check-5992" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding"><strong>resources/views/auth/register.blade.php</strong>を置き換えることができた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<p class="ng-scope">ルーティングに<strong>Route::auth();</strong>という記述が追加されています。これはphp artisan auth:makeコマンドを打った際にできたものです。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> ターミナルで以下のコマンドを入力してください</h3>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">ターミナル</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nv">$ </span>php artisan route:list

+--------+----------+------------------------------------+-------------------------+-----------------------------------------------------------------+------------+
<span class="p">|</span> Domain <span class="p">|</span> Method   <span class="p">|</span> URI                                <span class="p">|</span> Name                    <span class="p">|</span> Action                                                          <span class="p">|</span> Middleware <span class="p">|</span>
+--------+----------+------------------------------------+-------------------------+-----------------------------------------------------------------+------------+
<span class="p">|</span>        <span class="p">|</span> GET<span class="p">|</span>HEAD <span class="p">|</span> /                                  <span class="p">|</span>                         <span class="p">|</span> App<span class="se">\H</span>ttp<span class="se">\C</span>ontrollers<span class="se">\P</span>roductsController@index                   <span class="p">|</span> web        <span class="p">|</span>
<span class="hll"><span class="p">|</span>        <span class="p">|</span> GET<span class="p">|</span>HEAD <span class="p">|</span> login                              <span class="p">|</span>                         <span class="p">|</span> App<span class="se">\H</span>ttp<span class="se">\C</span>ontrollers<span class="se">\A</span>uth<span class="se">\A</span>uthController@showLoginForm          <span class="p">|</span> web,guest  <span class="p">|</span>
</span><span class="hll"><span class="p">|</span>        <span class="p">|</span> POST     <span class="p">|</span> login                              <span class="p">|</span>                         <span class="p">|</span> App<span class="se">\H</span>ttp<span class="se">\C</span>ontrollers<span class="se">\A</span>uth<span class="se">\A</span>uthController@login                  <span class="p">|</span> web,guest  <span class="p">|</span>
</span><span class="hll"><span class="p">|</span>        <span class="p">|</span> GET<span class="p">|</span>HEAD <span class="p">|</span> <span class="nb">logout</span>                             <span class="p">|</span>                         <span class="p">|</span> App<span class="se">\H</span>ttp<span class="se">\C</span>ontrollers<span class="se">\A</span>uth<span class="se">\A</span>uthController@logout                 <span class="p">|</span> web        <span class="p">|</span>
</span><span class="hll"><span class="p">|</span>        <span class="p">|</span> POST     <span class="p">|</span> password/email                     <span class="p">|</span>                         <span class="p">|</span> App<span class="se">\H</span>ttp<span class="se">\C</span>ontrollers<span class="se">\A</span>uth<span class="se">\P</span>asswordController@sendResetLinkEmail <span class="p">|</span> web,guest  <span class="p">|</span>
</span><span class="hll"><span class="p">|</span>        <span class="p">|</span> POST     <span class="p">|</span> password/reset                     <span class="p">|</span>                         <span class="p">|</span> App<span class="se">\H</span>ttp<span class="se">\C</span>ontrollers<span class="se">\A</span>uth<span class="se">\P</span>asswordController@reset              <span class="p">|</span> web,guest  <span class="p">|</span>
</span><span class="hll"><span class="p">|</span>        <span class="p">|</span> GET<span class="p">|</span>HEAD <span class="p">|</span> password/reset/<span class="o">{</span>token?<span class="o">}</span>            <span class="p">|</span>                         <span class="p">|</span> App<span class="se">\H</span>ttp<span class="se">\C</span>ontrollers<span class="se">\A</span>uth<span class="se">\P</span>asswordController@showResetForm      <span class="p">|</span> web,guest  <span class="p">|</span>
</span><span class="p">|</span>        <span class="p">|</span> GET<span class="p">|</span>HEAD <span class="p">|</span> products/search                    <span class="p">|</span>                         <span class="p">|</span> App<span class="se">\H</span>ttp<span class="se">\C</span>ontrollers<span class="se">\P</span>roductsController@search                  <span class="p">|</span> web        <span class="p">|</span>
<span class="p">|</span>        <span class="p">|</span> GET<span class="p">|</span>HEAD <span class="p">|</span> products/<span class="o">{</span>products<span class="o">}</span>                <span class="p">|</span> products.show           <span class="p">|</span> App<span class="se">\H</span>ttp<span class="se">\C</span>ontrollers<span class="se">\P</span>roductsController@show                    <span class="p">|</span> web        <span class="p">|</span>
<span class="p">|</span>        <span class="p">|</span> POST     <span class="p">|</span> products/<span class="o">{</span>products<span class="o">}</span>/reviews        <span class="p">|</span> products.reviews.store  <span class="p">|</span> App<span class="se">\H</span>ttp<span class="se">\C</span>ontrollers<span class="se">\R</span>eviewsController@store                    <span class="p">|</span> web        <span class="p">|</span>
<span class="p">|</span>        <span class="p">|</span> GET<span class="p">|</span>HEAD <span class="p">|</span> products/<span class="o">{</span>products<span class="o">}</span>/reviews/create <span class="p">|</span> products.reviews.create <span class="p">|</span> App<span class="se">\H</span>ttp<span class="se">\C</span>ontrollers<span class="se">\R</span>eviewsController@create                   <span class="p">|</span> web        <span class="p">|</span>
<span class="hll"><span class="p">|</span>        <span class="p">|</span> GET<span class="p">|</span>HEAD <span class="p">|</span> register                           <span class="p">|</span>                         <span class="p">|</span> App<span class="se">\H</span>ttp<span class="se">\C</span>ontrollers<span class="se">\A</span>uth<span class="se">\A</span>uthController@showRegistrationForm   <span class="p">|</span> web,guest  <span class="p">|</span>
</span><span class="hll"><span class="p">|</span>        <span class="p">|</span> POST     <span class="p">|</span> register                           <span class="p">|</span>                         <span class="p">|</span> App<span class="se">\H</span>ttp<span class="se">\C</span>ontrollers<span class="se">\A</span>uth<span class="se">\A</span>uthController@register               <span class="p">|</span> web,guest  <span class="p">|</span>
</span>+--------+----------+------------------------------------+-------------------------+-----------------------------------------------------------------+------------+
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">ログイン、新規登録に関するルーティングが追加されていることがわかります。試しにブラウザで<a href="http://localhost:8000/register">http://localhost:8000/register</a> にアクセスしてユーザーの作成画面に遷移するか確かめてみましょう。</p>

<h4 class="ng-scope">新規登録画面</h4>

<p class="ng-scope"><img src="./応用機能の実装_files/18c3e96db1ddbaf35c8f821903416530.png" alt="register"></p>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4300" class="ng-valid ng-scope ng-dirty ng-valid-parse">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-5993" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-5993" name="check-5993" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-valid ng-dirty ng-valid-parse ng-touched"><span ng-bind-html="check.text" class="ng-binding">サインアップ画面にアクセスすることができた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h1 class="ng-scope" id="17">STEP4：サインアウト、ログイン機能をつけよう</h1>

<p class="ng-scope">ユーザーの登録ができるようになりました。しかしこの状態では既存のユーザーでログインしたり、アカウントを切り替えることができません。そこで、サインアウト、ログインができるようにしましょう。機能はすでに実装できています。</p>

<h3 class="ng-scope">
<i class="icon dashboard"></i> 作業内容</h3>

<h5 class="ng-scope">1.サインアウトボタンを設置する</h5>

<h5 class="ng-scope">2.サインアウト後のリダイレクトを設定する</h5>

<h5 class="ng-scope">3.サインインしていない場合はログイン画面にリダイレクトさせる</h5>

<h2 class="ng-scope" id="18">1.サインアウトボタンを設置する</h2>

<p class="ng-scope">ログインするにもサインアウトができなければなりません。そこでまずはサインアウト機能から実装しましょう。</p>

<p class="ng-scope">サインアウトのボタンを以下のように<strong>投稿するボタン</strong>の横に設置しましょう。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/26.png" alt="サインアウトボタン"></p>

<p class="ng-scope">このサインアウトボタンを押したら<a href="http://localhost:8000/logout">/logout</a>にリクエストを飛ばすようにしましょう。</p>

<p class="ng-scope">Route::auth()で実装されるサインアウトのリクエストは<strong>GETメソッドです。</strong></p>

<p class="ng-scope">もう一度moooviのディレクトリでターミナルに<code>php artisan route:list</code>コマンドを打ち込んでみましょう。</p>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">ターミナル</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td>
<td class="code">
<div class="highlight"><pre>  <span class="nv">$ </span><span class="nb">cd</span> ~/projects/mooovi
  <span class="c"># 「mooovi」ディレクトリに移動</span>

  <span class="nv">$ </span>php artisan route:list
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">以下のように表示されている部分があると思います。</p>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="p">|</span> Domain <span class="p">|</span> Method   <span class="p">|</span> URI                                <span class="p">|</span> Name                    <span class="p">|</span> Action                                                          <span class="p">|</span> Middleware <span class="p">|</span>
<span class="p">|</span>        <span class="p">|</span> GET<span class="p">|</span>HEAD <span class="p">|</span> login                              <span class="p">|</span>                         <span class="p">|</span> App<span class="se">\H</span>ttp<span class="se">\C</span>ontrollers<span class="se">\A</span>uth<span class="se">\A</span>uthController@showLoginForm          <span class="p">|</span> web,guest  <span class="p">|</span>
<span class="p">|</span>        <span class="p">|</span> POST     <span class="p">|</span> login                              <span class="p">|</span>                         <span class="p">|</span> App<span class="se">\H</span>ttp<span class="se">\C</span>ontrollers<span class="se">\A</span>uth<span class="se">\A</span>uthController@login                  <span class="p">|</span> web,guest  <span class="p">|</span>
<span class="p">|</span>        <span class="p">|</span> GET<span class="p">|</span>HEAD <span class="p">|</span> <span class="nb">logout</span>                             <span class="p">|</span>                         <span class="p">|</span> App<span class="se">\H</span>ttp<span class="se">\C</span>ontrollers<span class="se">\A</span>uth<span class="se">\A</span>uthController@logout                 <span class="p">|</span> web        <span class="p">|</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope"><code>/logout</code>の横には<code>GET</code>と書いてあります。よってサインアウトのリクエストの種類はGETということです。</p>

<p class="ng-scope">サインアウトボタンをaタグで生成しましょう。aタグのリクエストはデフォルトでは<strong>GETメソッド</strong>となってしまいます。</p>

<p class="ng-scope">それでは、実際にサインアウトボタンを設置してみましょう。</p>

<div class="challenge ng-scope">
  <h3>
<i class="icon crown"></i> 問題3: サインアウトボタンを設置しましょう </h3>
  <div class="challenge_box">
    <h5>作業ファイル：resources/views/layouts/review_site.blade.php</h5>
    <h5>ヒント①：aタグを利用しましょう。</h5>
    <curriculum-question-container data-order="3" class="ng-scope"><button class="answer" ng-click="show_answer()" ng-show="isSolved">解答と解説を見る</button><button class="solve ng-binding ng-hide" ng-click="solve()" ng-hide="isSolved">残り時間 19分 35秒</button><button class="solved ng-hide" ng-click="solved()" ng-show="isSolving">解けた</button>
</curriculum-question-container>
  </div>
</div>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4301" class="ng-valid ng-scope ng-dirty ng-valid-parse">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-5994" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-5994" name="check-5994" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-valid ng-dirty ng-valid-parse ng-touched"><span ng-bind-html="check.text" class="ng-binding">例のようにサインアウトボタンをつけることができた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 class="ng-scope" id="19">2.サインアウト後のリダイレクトを設定する</h2>

<p class="ng-scope">サインアウトができるようになりましたが、お分かりのようにサインアウトボタンを押してもなにもおきません（しかし実際にサインアウトはできています）。サインアウト後にはログイン画面に遷移させるのが自然ですね。</p>

<p class="ng-scope">ここでは<strong>サインアウト後のリダイレクト先の設定</strong>をしましょう。ログイン画面はLaravelの機能によってすでに実装されています。</p>

<p class="ng-scope"><strong>ログイン画面</strong></p>

<p class="ng-scope"><img src="./応用機能の実装_files/31.png" alt="ログイン画面"></p>

<p class="ng-scope">サインアウト後のリダイレクト先のURLを設定するには<strong>$redirectAfterLogoutプロパティ</strong>にリダイレクト先URLを代入します。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_416"></i> $redirectAfterLogoutプロパティ</h3>

<p class="ng-scope">サインアウトしたあとのリダイレクト先を指定するプロパティとして<code>$redirectAfterLogout</code>があります。まずは$redirectAfterLogoutプロパティをAuthenticatesUsers.phpファイルに定義し、<strong>サインアウト後のリダイレクト先URL</strong>を代入します。</p>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">AuthenticatesUsers.php</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">trait</span> <span class="nx">AuthenticatesUsers</span>
<span class="p">{</span>
    <span class="k">use</span> <span class="nx">RedirectsUsers</span><span class="p">;</span>

<span class="hll">    <span class="k">protected</span> <span class="nv">$redirectAfterLogout</span> <span class="o">=</span> <span class="s1">'???'</span><span class="p">;</span>  <span class="c1">// サインアウト後のリダイレクト先URL</span>
</span>
    <span class="c1">// ... 省略</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<h3 class="ng-scope">
<i class="icon pen"></i> AuthenticatesUsers.phpに、下記のように追記しましょう</h3>

<p class="ng-scope">AuthenticatesUsers.phpファイルはvendor/laravel/framework/src/illuminate/Foundation/Auth/AuthenticatesUsers.phpとかなり深い階層に存在します。ですので<code>コマンド + T</code>を使ってファイル検索を使いましょう。コマンド + Tを押した時に検索欄が出てくるのでそこへAuthenticatesUsers.phpと入力してEnterを押しましょう。</p>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">AuthenticatesUsers.php</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">Illuminate\Foundation\Auth</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Auth</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Lang</span><span class="p">;</span>

<span class="k">trait</span> <span class="nx">AuthenticatesUsers</span>
<span class="p">{</span>
    <span class="k">use</span> <span class="nx">RedirectsUsers</span><span class="p">;</span>

<span class="hll">    <span class="k">protected</span> <span class="nv">$redirectAfterLogout</span> <span class="o">=</span> <span class="s1">'/login'</span><span class="p">;</span>  <span class="c1">// サインアウト後のリダイレクト先URL</span>
</span>
    <span class="c1">// ... 省略</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">では実際に確認してみましょう。</p>

<p class="ng-scope">画面右上にある「サインアウト」をクリックします。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/7512460bd6724932062cc6db66e95884.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//7512460bd6724932062cc6db66e95884.png"></p>

<p class="ng-scope">ログイン画面が表示されるようになっていることを確認しましょう。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/8e4819419f8ff3ad38855ee223014cb8.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//8e4819419f8ff3ad38855ee223014cb8.png"></p>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4302" class="ng-valid ng-scope ng-dirty ng-valid-parse">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-5995" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-5995" name="check-5995" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-valid ng-dirty ng-valid-parse ng-touched"><span ng-bind-html="check.text" class="ng-binding">サインアウトボタンを押した後、ログイン画面に移動するようになった</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 class="ng-scope" id="20">3.サインインしていない場合はログイン画面にリダイレクトさせる</h2>

<p class="ng-scope">この状態では<a href="http://localhost:8000/login" target="_blank">http://localhost:8000/login</a>にアクセスするか、サインアウトボタンを押さないとログイン画面に移動しません。では、<strong>レビューの投稿はログインしている状態でないとできないようにしましょう。</strong></p>

<p class="ng-scope">レビューの投稿画面(作品の検索画面もふくめて)に移動したらログイン画面にリダイレクトさせます。逆に言えばトップページや作品ページはログインしていなくてもアクセスできます。</p>

<p class="ng-scope"><strong>ログインしていない状態</strong></p>

<p class="ng-scope"><img src="./応用機能の実装_files/32.png" alt="レビューの投稿でのリダイレクト"></p>

<p class="ng-scope">レビューを投稿する画面に遷移するためのボタンは<strong>ヘッダーの「投稿するボタン」</strong>と<strong>作品ページの「この作品を投稿するボタン」</strong>の2つです。それぞれを押すとどのコントローラのどのアクションが呼ばれるのか確認しましょう。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_417"></i> middleware('auth')</h3>

<p class="ng-scope">php artisan make:authコマンドを打つとログイン画面とサインアップ画面を自動で用意してくれます。ユーザーがログインしているかどうかを確認し、ログインしていない場合はログインページにリダイレクトしたいです。pictweetと同様、middleware('auth')を使用して実装します。exceptやonlyオプションを組み合わせると特定のアクションを指定することもできます。</p>

<h3 class="ng-scope">【例】</h3>

<div class="code-frame ng-scope" data-lang="php"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">ProductsController</span> <span class="k">extends</span> <span class="nx">RankingController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
<span class="hll">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">middleware</span><span class="p">(</span><span class="s1">'auth'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'except'</span> <span class="o">=&gt;</span> <span class="s1">'index'</span><span class="p">]);</span>
</span>    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">index</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// 処理</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">show</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// 処理</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">上の例ではコンストラクタに$this-&gt;middleware('auth')を記載しています。さらにexcept以下にindexアクションを記述することでindexアクション以外にだけmiddleware('auth')が適用されるように指定をしています。</p>

<p class="ng-scope">今回の場合は、<strong>「投稿するボタン」</strong>と<strong>作品ページの「この作品を投稿するボタン」</strong>を押した際に動くアクションにmiddleware('auth')を用います。ただ、コントローラすべてのアクションにmiddleware('auth')を適応させるとレビューを投稿する時以外(ホームや作品ページ)でもリダイレクトの処理が実行されてしまいます。</p>

<p class="ng-scope">そこで、<strong>onlyオプションを使って、middleware('auth')をどのアクションのときに実行させるか選択しましょう</strong>。</p>

<p class="ng-scope">また、次の問題を解く際に1つ問題が発生します。PHPでは親クラスに定義しているメソッドと同じ名前のメソッドを子クラスで定義するとオーバーライド(上書き)し、親クラスのメソッドをなかったことにしてしまいます。そのため、明示的に子クラスで親クラスのメソッドを呼び出す必要がでてきます。このような場合はparentキーワードを使います。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_416"></i> parentキーワード</h3>

<p class="ng-scope">parentキーワードは親クラスを表すキーワードです。以下の例のように<code>parent::メソッド名</code>とすることで親クラスのメソッドを呼び出すことができます。</p>

<h3 class="ng-scope">[例]</h3>

<p class="ng-scope">以下は小クラスのコンストラクタで親クラスのコンストラクタを呼び出しています。</p>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">sample</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>51
52
53
54
55
56
57</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">class</span> <span class="nc">ProductsController</span> <span class="k">extends</span> <span class="nx">RankingController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<div class="challenge ng-scope">
  <h3>
<i class="icon crown"></i> 問題4：ログインしていない状態でレビューの投稿をしようとすると、ログイン画面にリダイレクトされるようにしましょう</h3>
  <div class="challenge_box">
    <h5>作業ファイル：どのファイルを編集すれば良いか、考えてみてください </h5>
    <h5>ヒント①：レビューを投稿する画面に移動できるのはヘッダーの「投稿するボタン」と作品ページの「この作品を投稿するボタン」の2つです</h5>
    <h5>ヒント②：レビューを投稿する画面のURLを見て、どのコントローラのどのアクションが呼ばれているか確認しましょう(php artisan route:listを使うか、routes.phpを見るとわかります)
</h5>
<h5>ヒント③：parentキーワードを使って親クラスのメソッドを呼び出しましょう</h5>

    <curriculum-question-container data-order="4" class="ng-scope"><button class="answer" ng-click="show_answer()" ng-show="isSolved">解答と解説を見る</button><button class="solve ng-binding ng-hide" ng-click="solve()" ng-hide="isSolved">残り時間 18分 54秒</button><button class="solved ng-hide" ng-click="solved()" ng-show="isSolving">解けた</button>
</curriculum-question-container>
  </div>
</div>

<p class="ng-scope">実際に確認してみましょう。<br>
「サインアウト」ボタンを押して、サインアウトしましょう。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/a0f7261d602b4f71a3ca27fb84aff80d.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//a0f7261d602b4f71a3ca27fb84aff80d.png"></p>

<p class="ng-scope">サインアウトするとログイン画面が表示されます。</p>

<p class="ng-scope">次に、ログイン画面の左上の「mooovi」というロゴをクリックしましょう。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/b3a997b801a3825a96221be0105095a5.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//b3a997b801a3825a96221be0105095a5.png"></p>

<p class="ng-scope">作品一覧画面が表示されます。<br>
次に、作品一覧画面の右上にある「投稿する」をクリックしましょう。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/8d2c63d68fd3a018d8afd582d2ab1390.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//8d2c63d68fd3a018d8afd582d2ab1390.png"></p>

<p class="ng-scope">そうすると、ログイン画面にリダイレクトされることを確認しましょう。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/b5130e16f879798977f10a0808f83b31.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//b5130e16f879798977f10a0808f83b31.png"></p>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4303" class="ng-valid ng-scope ng-dirty ng-valid-parse">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-5996" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-5996" name="check-5996" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-valid ng-dirty ng-valid-parse ng-touched"><span ng-bind-html="check.text" class="ng-binding">サインアップしていない状態でレビューを投稿しようとするとき、サインアップ画面にリダイレクトさせることができた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h1 class="ng-scope" id="21">STEP5：intervention/imageを使って画像のアップロード機能をつけよう</h1>

<p class="ng-scope">せっかくユーザーの概念を作ったのでユーザーのアイコンを設定できるようにしたいですね。</p>

<p class="ng-scope">そこでこのSTEPでは画像アップロード用のライブラリである<strong>intervention/image</strong>を使って、画像のアップロード機能を実装しましょう。intervention/imageライブラリを使うと非常に簡単に画像のアップロード機能を実装することができます。</p>

<h3 class="ng-scope">
<i class="icon dashboard"></i> 作業内容</h3>

<h5 class="ng-scope">1.intervention/imageをインストールする</h5>

<h5 class="ng-scope">2.usersテーブルにカラムを追加する</h5>

<h5 class="ng-scope">3.アプリケーションに画像ファイルを保存できるようにする</h5>

<h2 class="ng-scope" id="22">1.intervention/imageをインストールする</h2>

<p class="ng-scope">intervention/imageはライブラリなのでいつものようにcomposerを使ってインストールします。</p>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">ターミナル</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nv">$ </span>composer require intervention/image
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">次にconfig/app.phpに必要な記述を追加します。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> config/app.phpを以下のように編集しましょう</h3>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">app.php</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="s1">'providers'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="c1">// ..中略</span>
        <span class="nx">Illuminate\View\ViewServiceProvider</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
        <span class="nx">Collective\Html\HtmlServiceProvider</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
        <span class="c1">// 以下を追加</span>
<span class="hll">        <span class="nx">Intervention\Image\ImageServiceProvider</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>    <span class="c1">// 追加</span>
</span>
        <span class="c1">//.. 中略</span>
<span class="p">],</span>

<span class="s1">'aliases'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="c1">// ..中略</span>
        <span class="s1">'Html'</span> <span class="o">=&gt;</span> <span class="nx">Collective\Html\HtmlFacade</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
        <span class="s1">'Input'</span>     <span class="o">=&gt;</span> <span class="nx">Illuminate\Support\Facades\Input</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
        <span class="c1">// 以下を追加</span>
<span class="hll">        <span class="s1">'Image'</span>     <span class="o">=&gt;</span> <span class="nx">Intervention\Image\Facades\Image</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>    <span class="c1">// 追加</span>
</span>
        <span class="c1">//.. 中略</span>
<span class="p">],</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">これでintervention/imageの導入は完了します。</p>

<p class="ng-scope">ライブラリが導入できたかどうかはcomposer.jsonというファイルの中を見て確認します。以下のように<strong>intervention/image</strong>があれば正常にインストールされています。</p>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">composer.json</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="p">{</span>
    <span class="s2">"name"</span><span class="o">:</span> <span class="s2">"laravel/laravel"</span><span class="p">,</span>
    <span class="s2">"description"</span><span class="o">:</span> <span class="s2">"The Laravel Framework."</span><span class="p">,</span>
    <span class="s2">"keywords"</span><span class="o">:</span> <span class="p">[</span><span class="s2">"framework"</span><span class="p">,</span> <span class="s2">"laravel"</span><span class="p">],</span>
    <span class="s2">"license"</span><span class="o">:</span> <span class="s2">"MIT"</span><span class="p">,</span>
    <span class="s2">"type"</span><span class="o">:</span> <span class="s2">"project"</span><span class="p">,</span>
    <span class="s2">"require"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"php"</span><span class="o">:</span> <span class="s2">"&gt;=5.5.9"</span><span class="p">,</span>
        <span class="s2">"laravel/framework"</span><span class="o">:</span> <span class="s2">"5.2.*"</span><span class="p">,</span>
        <span class="s2">"laravelcollective/html"</span><span class="o">:</span> <span class="s2">"^5.2"</span><span class="p">,</span>
<span class="hll">        <span class="s2">"intervention/image"</span><span class="o">:</span> <span class="s2">"^2.3"</span>
</span>    <span class="p">},</span>
        <span class="c1">//.. 以下略</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4306" class="ng-pristine ng-valid ng-scope">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-5999" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-5999" name="check-5999" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">intervention/imageライブラリを導入できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4307" class="ng-pristine ng-valid ng-scope">
  <h4 class="ng-binding">
    <i class="icon check_icon_00"></i>要点チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-6000" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-6000" name="check-6000" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding"><strong>intervention/image</strong>は画像アップロードを簡単にできるようにするライブラリ</span></label><!-- end ngRepeat: check in checkbox.checks --><label for="check-6001" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-6001" name="check-6001" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">composer.jsonファイルのrequireキーを見るとインストールしたライブラリの一覧が見れる</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 class="ng-scope" id="23">2.usersテーブルにカラムを追加する</h2>

<p class="ng-scope">ユーザーのアイコン画像をアップロードして設定できるようにします。つまり、ユーザーモデルにアイコン画像用のカラムを追加する必要があるということです。これもintervention/imageを使うとほとんど自動で設定してくれます。</p>

<p class="ng-scope">ユーザーモデルに追加するアイコン画像のカラム名は<code>avatar</code>にしましょう。カラム追加用のマイグレーションファイルを作成する必要があります。これまでと同様の方法でマイグレーションファイルを作成しますが、追加の場合はテーブル作成の場合と異なり、--createオプションではなく<code>--tableオプション</code>を使いましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> ターミナルから以下のコマンドを実行しましょう</h3>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="c">#usersテーブルにavatarカラムを追加するためのマイグレーションファイルを作成</span>
php artisan make:migration add_avatar_to_users_table --table<span class="o">=</span>users
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">作成したマイグレーションファイルで以下の1行を追加しましょう。<br>
usersテーブルにtext型でavatarカラムを追加する</p>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">作成したマイグレーションファイル</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>13
14
15
16
17
18</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">public</span> <span class="k">function</span> <span class="nf">up</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nx">Schema</span><span class="o">::</span><span class="na">table</span><span class="p">(</span><span class="s1">'users'</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Blueprint</span> <span class="nv">$table</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">text</span><span class="p">(</span><span class="s1">'avatar'</span><span class="p">);</span>  <span class="c1">// この1行を追加</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">マイグレーションファイルに追記したら最後に実行しましょう。</p>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="c">#マイグレーションファイルの実行</span>
<span class="nv">$ </span>php artisan migrate
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">avatarのスペルに注意して入力しましょう。<br>
これで画像のアップロードに必要なカラムがusersテーブルに追加されました。Sequel Proを使って確認してみましょう。</p>

<p class="ng-scope">これで画像のアップロードに必要なカラムがusersテーブルに追加されました。</p>

<p class="ng-scope">Sequel Proでusersテーブルに、以下のようにavatarカラムが追加されているか確認しましょう。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/dedcd874aa194289549e0e5ae7f4e9d9.png" alt="avatarカラム"></p>

<h2 class="ng-scope" id="24">3.アプリケーションに画像ファイルを保存できるようにする</h2>

<p class="ng-scope">画像ファイルを保存するまでの流れは以下です。<br>
①フォームから画像を登録<br>
②アプリケーションのpublic配下に画像ファイルを保存する</p>

<h3 class="ng-scope">①フォームから画像を登録</h3>

<p class="ng-scope">サインアップ画面にニックネームを入力するフォームとアイコン画像をアップロードできるフォームを作りましょう。完成すると、以下のような形です。</p>

<p class="ng-scope"><strong>サインアップ画面</strong></p>

<p class="ng-scope"><img src="./応用機能の実装_files/35.png" alt="サインアップ画面"></p>

<p class="ng-scope">サインアップ画面は<strong>Formファサード</strong>を使って記述されています。<br>
ニックネームは<strong>テキストフィールド</strong>、アイコン画像には<strong>ファイルフィールド</strong>と呼ばれるファイルアップロード用のフィールドを生成します。<br>
テキストフィールドは<code>Form::text</code>、ファイルフィールドは<code>Form::file</code>を利用することで生成できます。また、カラム名の指定も忘れずにしましょう。</p>

<h3 class="ng-scope">【例】</h3>

<ul class="ng-scope">
<li>テキストフィールドの生成</li>
</ul>

<div class="code-frame ng-scope" data-lang="rhtml"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre>{{ Form::text('カラム名') }}
</pre></div>
</td>
</tr></tbody></table></div>

<ul class="ng-scope">
<li>ファイルフィールドの生成</li>
</ul>

<div class="code-frame ng-scope" data-lang="rhtml"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre>{{ Form::file('カラム名') }}
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">さらに、画像をアップロードする際はフォームでファイルのアップロードを指定する必要があります。以下のように<code>filesキー</code>を使って指定します。</p>

<div class="code-frame ng-scope" data-lang="rhtml"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre>{!! Form::open(array('files' =&gt; true)) !!}
</pre></div>
</td>
</tr></tbody></table></div>

<h3 class="ng-scope">
<i class="icon pen"></i> resources/views/auth/register.blade.phpを以下のように編集しましょう</h3>

<div class="code-frame ng-scope" data-lang="rhtml"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54</pre></div></td>
<td class="code">
<div class="highlight"><pre>@extends('layout')

@section('content')
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"bgcolor-white pt1em pb1em"</span> <span class="na">id=</span><span class="s">"contents"</span><span class="nt">&gt;</span>  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"main_cnt_wrapper"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjContentsBody"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"yjContainer"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form_box"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h2&gt;</span>mooovi<span class="nt">&lt;span&gt;</span>新規登録<span class="nt">&lt;/span&gt;&lt;/h2&gt;</span>
<span class="hll">         {!! Form::open(array('files' =&gt; true)) !!}
</span>          @if (count($errors) &gt; 0)
            <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"error_explanation"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;ul&gt;</span>
                @foreach ($errors-&gt;all() as $error)
                  <span class="nt">&lt;li&gt;</span>{{ $error }}<span class="nt">&lt;/li&gt;</span>
                @endforeach
              <span class="nt">&lt;/ul&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
          @endif
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"label"</span><span class="nt">&gt;</span>
            {{ Form::label('email') }}
            {{ Form::email('email', '', ['placeholder' =&gt; 'メールアドレスを入力']) }}
          <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"label"</span><span class="nt">&gt;</span>
            {{ Form::label('password') }}
            {{ Form::password('password', ['placeholder' =&gt; 'パスワードを入力']) }}
          <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"label"</span><span class="nt">&gt;</span>
            {{ Form::label('password_confirmation') }}
            {{ Form::password('password_confirmation', ['placeholder' =&gt; 'パスワードを入力（確認）']) }}
          <span class="nt">&lt;/div&gt;</span>
<span class="hll">          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"label"</span><span class="nt">&gt;</span>
</span><span class="hll">            {{ Form::label('name') }}
</span><span class="hll">            {{ Form::text('name') }}
</span><span class="hll">          <span class="nt">&lt;/div&gt;</span>
</span><span class="hll">          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
</span><span class="hll">            {{ Form::file('avatar') }}
</span><span class="hll">          <span class="nt">&lt;/div&gt;</span>
</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"submit"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"actions"</span><span class="nt">&gt;</span>
            {{ Form::submit('Create User', ['class' =&gt; 'btn btn--block']) }}
          <span class="nt">&lt;/div&gt;&lt;/div&gt;</span>

          {!! Form::close() !!}

          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"more_link_box"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;strong&gt;</span>すでにアカウントを持っていますか？<span class="nt">&lt;/strong&gt;</span>
          <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/login"</span><span class="nt">&gt;</span>Log in<span class="nt">&lt;/a&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
@endsection
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4308" class="ng-pristine ng-valid ng-scope">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-6002" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-6002" name="check-6002" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">新規登録画面にニックネームとavatar用のフォームを追加することができた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4309" class="ng-pristine ng-valid ng-scope">
  <h4 class="ng-binding">
    <i class="icon check_icon_00"></i>要点チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-6003" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-6003" name="check-6003" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">画像をアップロードする際はForm::open()の引数に<code>'files' =&gt; true</code>を指定する</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h3 class="ng-scope">②アプリケーションのpublic配下に画像ファイルを保存する</h3>

<p class="ng-scope">画像ファイルをpublic配下に保存する処理はAuthControllerのcreateアクションで行います。フォームから送られてきたデータはcreateアクションの引数<code>$data</code>の中に格納されており、$data['avatar']とするとavatarの情報が取得できます。</p>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nv">$data</span><span class="o">[</span><span class="s1">'avatar'</span><span class="o">]</span>
<span class="o">=</span>&gt; Illuminate<span class="se">\H</span>ttp<span class="se">\U</span>ploadedFile <span class="o">{</span><span class="c">#182</span>
     path: <span class="s2">"/private/var/folders/7g/sgb_lqdd5db2g2106_7rtszh0000gn/T"</span>,
     filename: <span class="s2">"phpdyKcY0"</span>,
     basename: <span class="s2">"phpdyKcY0"</span>,
     pathname: <span class="s2">"/private/var/folders/7g/sgb_lqdd5db2g2106_7rtszh0000gn/T/phpdyKcY0"</span>,
     extension: <span class="s2">""</span>,
     realPath: <span class="s2">"/private/var/folders/7g/sgb_lqdd5db2g2106_7rtszh0000gn/T/phpdyKcY0"</span>,
     aTime: 2016-08-19 18:20:17,
     mTime: 2016-08-19 18:20:17,
     cTime: 2016-08-19 18:20:17,
     inode: 55075910,
     size: 919765,
     perms: 0100600,
     owner: 501,
     group: 20,
     <span class="nb">type</span>: <span class="s2">"file"</span>,
     writable: <span class="nb">true</span>,
     readable: <span class="nb">true</span>,
     executable: <span class="nb">false</span>,
     file: <span class="nb">true</span>,
     dir: <span class="nb">false</span>,
     link: <span class="nb">false</span>,
   <span class="o">}</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">しかし今欲しいのは画像のファイル名です。画像ファイルのオリジナル名を取得するには<code>getClientOriginalName</code>メソッドを利用します。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_416"></i> getClientOriginalNameメソッド</h3>

<p class="ng-scope">getClientOriginalNameメソッドはアップロードしたファイルのオリジナル名を取得します。</p>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nv">$data</span><span class="o">[</span><span class="s1">'avatar'</span><span class="o">]</span>-&gt;getClientOriginalName<span class="o">()</span>
<span class="o">=</span>&gt; <span class="s2">"kyoto-newone-01.png"</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<h3 class="ng-scope">
<i class="icon pen"></i> AuthControllerのcreateアクションを以下のように編集しましょう</h3>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">AuthController</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>64
65
66
67
68
69
70
71
72
73</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">protected</span> <span class="k">function</span> <span class="nf">create</span><span class="p">(</span><span class="k">array</span> <span class="nv">$data</span><span class="p">)</span>
<span class="p">{</span>
<span class="hll">    <span class="nv">$fileName</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'avatar'</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">getClientOriginalName</span><span class="p">();</span>
</span>
    <span class="k">return</span> <span class="nx">User</span><span class="o">::</span><span class="na">create</span><span class="p">([</span>
        <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'name'</span><span class="p">],</span>
        <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'email'</span><span class="p">],</span>
        <span class="s1">'password'</span> <span class="o">=&gt;</span> <span class="nx">bcrypt</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'password'</span><span class="p">]),</span>
    <span class="p">]);</span>
<span class="p">}</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">これで画像ファイル名を取得することができました。<br>
次は、取得した画像ファイルをアプリケーションのpublic配下に保存します。今回はpublic/images/配下に保存することとします。まずはimagesディレクトリを作成しましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> public/imagesディレクトリを作成しましょう</h3>

<ul class="filetree ng-scope">
  <li class="t-folder"> public
    <ul>
      <li class="t-folder"> images
      </li>
    </ul>
  </li>
</ul>

<p class="ng-scope">public配下に画像を保存するために先ほどインストールしたintervention/imageライブラリに定義されているImageクラスを使います。Imageクラスを使うにはこれまでと同様に、useを使ってインクルードする必要があります。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> Imageクラスをインクルードしましょう</h3>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">AuthController.php</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">App\Http\Controllers\Auth</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\User</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Validator</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Http\Controllers\Controller</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Foundation\Auth\ThrottlesLogins</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Foundation\Auth\AuthenticatesAndRegistersUsers</span><span class="p">;</span>
<span class="hll"><span class="k">use</span> <span class="nx">Image</span><span class="p">;</span> <span class="c1">//この1行を追記</span>
</span></pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">public/imagesへの保存は以下の様に行います。</p>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre>Image::make<span class="o">(</span><span class="nv">$data</span><span class="o">[</span><span class="s1">'avatar'</span><span class="o">])</span>-&gt;save<span class="o">(</span>public_path<span class="o">()</span> . <span class="s1">'/images/'</span> . <span class="nv">$fileName</span><span class="o">)</span><span class="p">;</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">intervention/imageライブラリに定義されている<code>Image::makeメソッド</code>の引数にアップロードファイルのデータを渡すとIntervention\Image\Imageインスタンスを生成します。Intervention\Image\Imageインスタンスには画像の反転や透明度の調整などを行うための多くのメソッドが用意されています。その内の1つである<code>save</code>メソッドを使うとアプリケーションのディレクトリ内に画像ファイルを保存することができます。引数には保存先のパスを指定します。</p>

<p class="ng-scope">今回はpublic/images/配下に画像ファイルを保存したいので、saveメソッドの引数に<code>public_path() . '/images/' . $fileName</code>を指定します。<code>public_path()</code>publicディレクトリのパスを生成します。それでは実際に追記していきましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> AuthControllerを以下のように編集しましょう</h3>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">AuthController.php</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td>
<td class="code">
<div class="highlight"><pre>    <span class="k">protected</span> <span class="k">function</span> <span class="nf">create</span><span class="p">(</span><span class="k">array</span> <span class="nv">$data</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$fileName</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'avatar'</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">getClientOriginalName</span><span class="p">();</span>
<span class="hll">        <span class="nx">Image</span><span class="o">::</span><span class="na">make</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'avatar'</span><span class="p">])</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nx">public_path</span><span class="p">()</span> <span class="o">.</span> <span class="s1">'/images/'</span> <span class="o">.</span> <span class="nv">$fileName</span><span class="p">);</span>
</span>
        <span class="k">return</span> <span class="nx">User</span><span class="o">::</span><span class="na">create</span><span class="p">([</span>
            <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'name'</span><span class="p">],</span>
            <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'email'</span><span class="p">],</span>
            <span class="s1">'password'</span> <span class="o">=&gt;</span> <span class="nx">bcrypt</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'password'</span><span class="p">]),</span>
        <span class="p">]);</span>
    <span class="p">}</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">これで画像ファイルをpublic/images配下に保存する実装は完成です。</p>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4310" class="ng-pristine ng-valid ng-scope">
  <h4 class="ng-binding">
    <i class="icon check_icon_00"></i>要点チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-6004" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-6004" name="check-6004" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">画像はpublicディレクトリ配下にキャッシュ(ストック)する必要がある</span></label><!-- end ngRepeat: check in checkbox.checks --><label for="check-6005" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-6005" name="check-6005" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding"><strong>getClientOriginalName()メソッド</strong>はアップロードしたファイルのオリジナル名を取得してくれる</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h1 class="ng-scope" id="25">STEP6：画像を保存できるようにしよう</h1>

<p class="ng-scope">intervention/imageによってユーザーのアイコン画像のアップロードが可能となったのでavatarをデータベースに保存できるようにしましょう。</p>

<h3 class="ng-scope">
<i class="icon dashboard"></i> 作業内容</h3>

<h5 class="ng-scope">1.avatarが保存できるようにする</h5>

<h5 class="ng-scope">2.Userモデルにプロパティを設定する</h5>

<h5 class="ng-scope">3.バリデーションを設定する</h5>

<h2 class="ng-scope" id="26">1.avatarが保存できるようにする</h2>

<p class="ng-scope">新規登録ページからユーザーの作成ボタンを押すと、ルーティングを通して<code>AuthController.phpのcreateアクション</code>が実行されます。<br>
STEP5を終えて、AuthControllerのcreateアクションの中身は以下の様な表記になっているかと思います。</p>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">AuthController.php</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td>
<td class="code">
<div class="highlight"><pre>    <span class="k">protected</span> <span class="k">function</span> <span class="nf">create</span><span class="p">(</span><span class="k">array</span> <span class="nv">$data</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$fileName</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'avatar'</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">getClientOriginalName</span><span class="p">();</span>
        <span class="nx">Image</span><span class="o">::</span><span class="na">make</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'avatar'</span><span class="p">])</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nx">public_path</span><span class="p">()</span> <span class="o">.</span> <span class="s1">'/images/'</span> <span class="o">.</span> <span class="nv">$fileName</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">User</span><span class="o">::</span><span class="na">create</span><span class="p">([</span>
            <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'name'</span><span class="p">],</span>
            <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'email'</span><span class="p">],</span>
            <span class="s1">'password'</span> <span class="o">=&gt;</span> <span class="nx">bcrypt</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'password'</span><span class="p">]),</span>
        <span class="p">]);</span>
    <span class="p">}</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">ここにavatar保存の処理を追加しましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i>AuthController.phpを以下のように編集しましょう</h3>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">AuthController.php</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">protected</span> <span class="k">function</span> <span class="nf">create</span><span class="p">(</span><span class="k">array</span> <span class="nv">$data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">User</span><span class="o">::</span><span class="na">create</span><span class="p">([</span>
        <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'name'</span><span class="p">],</span>
        <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'email'</span><span class="p">],</span>
        <span class="s1">'password'</span> <span class="o">=&gt;</span> <span class="nx">bcrypt</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'password'</span><span class="p">]),</span>
<span class="hll">        <span class="s1">'avatar'</span> <span class="o">=&gt;</span> <span class="nv">$fileName</span><span class="p">,</span>
</span>    <span class="p">]);</span>
<span class="p">}</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">これでavatarが保存されるようになりました。保存は画像ファイルの状態で保存したいため、$fileNameを指定します。</p>

<p class="ng-scope">また、32行目に <code>$redirectToプロパティ</code>が定義されています。ここには新規登録後の遷移先パスを指定するようになっています。現在<code>/home</code>になっているので、新規登録後はホーム画面に遷移するようにしましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i>AuthController.phpを以下のように編集しましょう</h3>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">AuthController.php</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>32</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="hll"><span class="k">protected</span> <span class="nv">$redirectTo</span> <span class="o">=</span> <span class="s1">'/'</span><span class="p">;</span>
</span></pre></div>
</td>
</tr></tbody></table>
</div>

<h2 class="ng-scope" id="27">2.Userモデルにプロパティを設定する</h2>

<p class="ng-scope">しかし、今のままアイコン画像をアップロードしてユーザーの作成ボタンを押すと、<strong>avatarが設定されません。</strong>これは複数のデータを一度に保存する場合は$fillableもしくは$guardedプロパティを指定しないとはじかれるからです。</p>

<p class="ng-scope"><strong>avatar</strong>のパラメータを許可するよう、$fillableプロパティに追加しましょう。</p>

<div class="challenge ng-scope">
  <h3>
<i class="icon crown"></i> 問題5：Userモデルに複数保存を可能にするためのプロパティを設定しましょう</h3>
  <div class="challenge_box">
    <h5>作業ファイル：app/User.php</h5>
    <h5>ヒント①：avatarというキーを許可するよう、追記してください。</h5>
    <curriculum-question-container data-order="5" class="ng-scope"><button class="answer ng-hide" ng-click="show_answer()" ng-show="isSolved">解答と解説を見る</button><button class="solve ng-binding" ng-click="solve()" ng-hide="isSolved">課題を解く</button><button class="solved ng-hide" ng-click="solved()" ng-show="isSolving">解けた</button>
</curriculum-question-container>
  </div>
</div>

<p class="ng-scope">実際に、ユーザーのニックネームと画像を設定してみましょう。</p>

<p class="ng-scope">新規登録画面でニックネームとアバター画像を含む、すべての情報を入力して登録しましょう。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/25e61c3ace9dbc91669185b15c7d2964.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//25e61c3ace9dbc91669185b15c7d2964.png"></p>

<p class="ng-scope">新規登録したら、Sequal proでusersの情報を確認してみましょう。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/0e35bbd9e2812c89661d30bb0e2be218.png" alt="nameとavatar"></p>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4311" class="ng-pristine ng-valid ng-scope">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-6006" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-6006" name="check-6006" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">サインアップ画面でニックネームと画像を設定できるようになった</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4312" class="ng-pristine ng-valid ng-scope">
  <h4 class="ng-binding">
    <i class="icon check_icon_00"></i>要点チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-6007" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-6007" name="check-6007" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">create()メソッドで複数データを保存する際は$fillableプロパティを設定する</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 class="ng-scope" id="28">3.バリデーションを設定する</h2>

<p class="ng-scope">現在の状態ではニックネーム、パスワード、emailを入力していればサインアップできます。しかしavatarも必須の入力項目にしたいです。そこでavatarが入力されていなければエラーを返すように<strong>バリデーション</strong>を設定しましょう。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_422"></i> validation(検証)</h3>

<p class="ng-scope"><code>validation</code>とは、入力フォームを通じてビューからサーバー側へパラメーターが送られてきた際、正常な値か検証することができる機能です。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_423"></i> validatorメソッド</h3>

<p class="ng-scope">AuthControllerにはvalidatorメソッドが定義されています。validatorメソッドのValidator::makeメソッドにバリデーションをかけるカラムとその内容を記述します。<br>
name、email、passwordカラムのいずれにも指定している<code>required</code>はフォームの中身があるかないかを検出し、ない場合は保存を実行せず元のビューにリダイレクトさせます。</p>

<p class="ng-scope">例えば、userのnameを入力必須にしたい場合、以下のように書くことができます。</p>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">AuthController.php</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">protected</span> <span class="k">function</span> <span class="nf">validator</span><span class="p">(</span><span class="k">array</span> <span class="nv">$data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">Validator</span><span class="o">::</span><span class="na">make</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="p">[</span>
<span class="hll">        <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'required'</span><span class="p">,</span>
</span>    <span class="p">]);</span>
<span class="p">}</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">この状態でユーザーの新規登録時にnameを入力しなかった場合、以下のようなエラーが表示され、userを登録することができなくなります。</p>

<p class="ng-scope"><strong>ニックネームを入力しなかった場合</strong></p>

<p class="ng-scope"><img src="./応用機能の実装_files/d4fd099be567011e9d11836c276ab211.png" alt="バリデーション"></p>

<p class="ng-scope">さらにニックネームが必須項目であることを知らせるために以下のように<strong>テキストフィールドにプレイスホルダー</strong>を設定しましょう。</p>

<h3 class="ng-scope">
<i class="icon information" id="term_424"></i>placeholderオプション</h3>

<p class="ng-scope">フォームの中に、<code>''</code>で囲んだ文字をフォームの値が空の時に薄く表示しておくことができます。userが何を入力すれば良いかわかりやすくするためです。Form::textメソッドのオプションとして、以下のように利用します。</p>

<div class="code-frame ng-scope" data-lang="html">
<div class="code-lang"><span class="bold">register.blade.php</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre>{{ Form::text('name', '', ['placeholder' =&gt; 'ニックネームを入力（必須）']) }}
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">すると、ブラウザ上では以下のように表示されます。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/36.png" alt="プレイスホルダーの設定"></p>

<p class="ng-scope">早速、バリデーションとプレースホルダーを実装してみましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> AuthController.phpに以下を追記しましょう</h3>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">AuthController.php</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>50
51
52
53
54
55
56
57
58</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">protected</span> <span class="k">function</span> <span class="nf">validator</span><span class="p">(</span><span class="k">array</span> <span class="nv">$data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nx">Validator</span><span class="o">::</span><span class="na">make</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="p">[</span>
        <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'required|max:255'</span><span class="p">,</span>
        <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="s1">'required|email|max:255|unique:users'</span><span class="p">,</span>
        <span class="s1">'password'</span> <span class="o">=&gt;</span> <span class="s1">'required|min:6|confirmed'</span><span class="p">,</span>
<span class="hll">        <span class="s1">'avatar'</span> <span class="o">=&gt;</span> <span class="s1">'required'</span><span class="p">,</span>
</span>    <span class="p">]);</span>
<span class="p">}</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<h3 class="ng-scope">
<i class="icon pen"></i>resources/views/auth/register.blade.phpを、以下のように編集しましょう</h3>

<div class="code-frame ng-scope" data-lang="rhtml">
<div class="code-lang"><span class="bold">register.blade.php</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54</pre></div></td>
<td class="code">
<div class="highlight"><pre>@extends('layout')

@section('content')
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"bgcolor-white pt1em pb1em"</span> <span class="na">id=</span><span class="s">"contents"</span><span class="nt">&gt;</span>  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"main_cnt_wrapper"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjContentsBody"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"yjContainer"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form_box"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h2&gt;</span>mooovi<span class="nt">&lt;span&gt;</span>新規登録<span class="nt">&lt;/span&gt;&lt;/h2&gt;</span>
         {!! Form::open(array('files' =&gt; true)) !!}
          @if (count($errors) &gt; 0)
            <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"error_explanation"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;ul&gt;</span>
                @foreach ($errors-&gt;all() as $error)
                  <span class="nt">&lt;li&gt;</span>{{ $error }}<span class="nt">&lt;/li&gt;</span>
                @endforeach
              <span class="nt">&lt;/ul&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
          @endif
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"label"</span><span class="nt">&gt;</span>
            {{ Form::label('email') }}
            {{ Form::email('email', '', ['placeholder' =&gt; 'メールアドレスを入力']) }}
          <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"label"</span><span class="nt">&gt;</span>
            {{ Form::label('password') }}
            {{ Form::password('password', ['placeholder' =&gt; 'パスワードを入力']) }}
          <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"label"</span><span class="nt">&gt;</span>
            {{ Form::label('password_confirmation') }}
            {{ Form::password('password_confirmation', ['placeholder' =&gt; 'パスワードを入力（確認）']) }}
          <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"label"</span><span class="nt">&gt;</span>
            {{ Form::label('name') }}
<span class="hll">            {{ Form::text('name', '', ['placeholder' =&gt; 'ニックネームを入力（必須）']) }}
</span>          <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
            {{ Form::file('avatar') }}
          <span class="nt">&lt;/div&gt;</span>

          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"submit"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"actions"</span><span class="nt">&gt;</span>
            {{ Form::submit('Create User', ['class' =&gt; 'btn btn--block']) }}
          <span class="nt">&lt;/div&gt;&lt;/div&gt;</span>

          {!! Form::close() !!}

          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"more_link_box"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;strong&gt;</span>すでにアカウントを持っていますか？<span class="nt">&lt;/strong&gt;</span>
          <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/login"</span><span class="nt">&gt;</span>Log in<span class="nt">&lt;/a&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
@endsection
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">実装できたら、実際にプレースホルダーが表示される確認してみましょう。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/7cd5c7ad844a3308c50d1dfa726d42f2.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//7cd5c7ad844a3308c50d1dfa726d42f2.png"></p>

<p class="ng-scope">また、avatarを入力せずにuserの新規登録を行おうとするとエラーが出るか確かめましょう。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/97d70a5a1ee9aa943f891c19080461ab.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//97d70a5a1ee9aa943f891c19080461ab.png"></p>

<p class="ng-scope"><img src="./応用機能の実装_files/4e733d64ec593a0d7ba474959e9ef292.png" alt="name_validation"></p>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4313" class="ng-pristine ng-valid ng-scope">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-6008" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-6008" name="check-6008" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">ニックネームを設定してないときはエラーを出すようにした</span></label><!-- end ngRepeat: check in checkbox.checks --><label for="check-6009" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-6009" name="check-6009" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">ニックネームの入力欄にプレイスホルダーを設定できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h1 class="ng-scope" id="29">STEP7：アソシエーションを利用しよう</h1>

<p class="ng-scope">レビューの保存時に「誰が書いたレビューなのか」という情報を保存できるようにします。また、レビューの表示時にレビューを書いた人のnameを表示できるよう実装しましょう。そして、レビューの投稿画面の方のニックネームの入力欄は消してしまいましょう。</p>

<h3 class="ng-scope">
<i class="icon dashboard"></i> 作業内容</h3>

<h5 class="ng-scope">1.ニックネームの入力欄を消す</h5>

<h5 class="ng-scope">2.userモデルとreviewモデルの間にアソシエーションを設定する</h5>

<h2 class="ng-scope" id="30">1.ニックネームの入力欄を消す</h2>

<p class="ng-scope">現在、以下のようにレビューの投稿画面にはニックネームを入力するテキストフィールドがあります。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/38.png" alt="投稿画面"></p>

<p class="ng-scope">レビューを投稿するユーザーのニックネームはサインアップの段階ですでに設定済みなのでこのテキストフィールドは不要ですね。消してしまいましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> resources/views/reviews/create.blade.phpを編集し、不要なフォームを削除しましょう</h3>

<p class="ng-scope"><strong>削除前</strong></p>

<div class="code-frame ng-scope" data-lang="html">
<div class="code-lang"><span class="bold">create.blade.php</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61</pre></div></td>
<td class="code">
<div class="highlight"><pre>@extends('layout')

@section('content')
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"main_cnt_wrapper"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjContentsBody"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"yjContainer"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"yjGuid"</span><span class="nt">&gt;&lt;a</span> <span class="na">id=</span><span class="s">"yjContentsStart"</span> <span class="na">name=</span><span class="s">"yjContentsStart"</span><span class="nt">&gt;&lt;/a&gt;&lt;img</span> <span class="na">alt=</span><span class="s">"ここから本文です"</span> <span class="na">height=</span><span class="s">"1"</span> <span class="na">src=</span><span class="s">"http://i.yimg.jp/yui/jp/tmpl/1.1.0/audionav.gif"</span> <span class="na">width=</span><span class="s">"1"</span><span class="nt">&gt;&lt;/span&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjMain"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;article</span> <span class="na">class=</span><span class="s">"section"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"header header--section"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;h2</span> <span class="na">class=</span><span class="s">"text-middle"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"icon-movie color-gray-light"</span><span class="nt">&gt;&lt;/i&gt;</span>投稿
              <span class="nt">&lt;/h2&gt;</span>
            <span class="nt">&lt;/header&gt;</span>
            <span class="nt">&lt;div&gt;</span>
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"listview js-lazy-load-images"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;li</span> <span class="na">style=</span><span class="s">"margin-bottom: 15px"</span><span class="nt">&gt;</span>
                  <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"listview__element--right-icon"</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"box"</span><span class="nt">&gt;</span>
                      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"box__cell w80"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"thumbnail thumbnail--photo"</span><span class="nt">&gt;</span>
                          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"thumbnail__figure"</span> <span class="na">style=</span><span class="s">"background-image: url({{ $product-&gt;image_url }});"</span><span class="nt">&gt;&lt;/div&gt;</span>
                        <span class="nt">&lt;/div&gt;</span>
                      <span class="nt">&lt;/div&gt;</span>
                      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"box__cell pl1em"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;h3</span> <span class="na">class=</span><span class="s">"text-middle text-break color-sub"</span><span class="nt">&gt;</span>
                          {{ $product-&gt;title }}
                        <span class="nt">&lt;/h3&gt;</span>
                        <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"text-xsmall"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;/p&gt;</span>
                        <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"text-xsmall opacity-60"</span><span class="nt">&gt;&lt;/p&gt;</span>
                      <span class="nt">&lt;/div&gt;</span>
                    <span class="nt">&lt;/div&gt;</span>
                  <span class="nt">&lt;/a&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;/ul&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
          {{ Form::model($review, array('action' =&gt; array('ReviewsController@store', $product-&gt;id))) }}
<span class="hll">          <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"margin: 8px 0"</span><span class="nt">&gt;</span>
</span><span class="hll">            {{ Form::label('nickname', 'ニックネーム', ['style' =&gt; 'margin-right:8']) }}
</span><span class="hll">            {{ Form::text('nickname') }}
</span><span class="hll">          <span class="nt">&lt;/div&gt;</span>
</span>          <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"margin: 8px 0"</span><span class="nt">&gt;</span>
            {{ Form::label('email', '評価', ['style' =&gt;  'margin-right:8;']) }}
            {{ Form::selectRange('rate', 1, 10, ['placeholder' =&gt; '評価', 'class' =&gt; 'searh__query', 'style' =&gt; 'text-align: right;']) }}
          <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"margin: 8px 0"</span><span class="nt">&gt;</span>
            {{ Form::textarea('review', '', ['placeholder' =&gt; 'レビューを書いてね！', 'style' =&gt; 'width: 100%;height: 300px;']) }}
          <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col10 push1"</span><span class="nt">&gt;</span>
              {{ Form::submit('投稿する', ['class' =&gt; 'btn btn--block']) }}
            <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
          {!! Form::close() !!}
        <span class="nt">&lt;/article&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjSub"</span><span class="nt">&gt;</span>
@endsection
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope"><strong>削除後</strong></p>

<div class="code-frame ng-scope" data-lang="rhtml">
<div class="code-lang"><span class="bold">create.blade.php</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57</pre></div></td>
<td class="code">
<div class="highlight"><pre>@extends('layout')

@section('content')
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"main_cnt_wrapper"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjContentsBody"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"yjContainer"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"yjGuid"</span><span class="nt">&gt;&lt;a</span> <span class="na">id=</span><span class="s">"yjContentsStart"</span> <span class="na">name=</span><span class="s">"yjContentsStart"</span><span class="nt">&gt;&lt;/a&gt;&lt;img</span> <span class="na">alt=</span><span class="s">"ここから本文です"</span> <span class="na">height=</span><span class="s">"1"</span> <span class="na">src=</span><span class="s">"http://i.yimg.jp/yui/jp/tmpl/1.1.0/audionav.gif"</span> <span class="na">width=</span><span class="s">"1"</span><span class="nt">&gt;&lt;/span&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjMain"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;article</span> <span class="na">class=</span><span class="s">"section"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"header header--section"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;h2</span> <span class="na">class=</span><span class="s">"text-middle"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"icon-movie color-gray-light"</span><span class="nt">&gt;&lt;/i&gt;</span>投稿
              <span class="nt">&lt;/h2&gt;</span>
            <span class="nt">&lt;/header&gt;</span>
            <span class="nt">&lt;div&gt;</span>
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"listview js-lazy-load-images"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;li</span> <span class="na">style=</span><span class="s">"margin-bottom: 15px"</span><span class="nt">&gt;</span>
                  <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"listview__element--right-icon"</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"box"</span><span class="nt">&gt;</span>
                      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"box__cell w80"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"thumbnail thumbnail--photo"</span><span class="nt">&gt;</span>
                          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"thumbnail__figure"</span> <span class="na">style=</span><span class="s">"background-image: url({{ $product-&gt;image_url }});"</span><span class="nt">&gt;&lt;/div&gt;</span>
                        <span class="nt">&lt;/div&gt;</span>
                      <span class="nt">&lt;/div&gt;</span>
                      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"box__cell pl1em"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;h3</span> <span class="na">class=</span><span class="s">"text-middle text-break color-sub"</span><span class="nt">&gt;</span>
                          {{ $product-&gt;title }}
                        <span class="nt">&lt;/h3&gt;</span>
                        <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"text-xsmall"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;/p&gt;</span>
                        <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"text-xsmall opacity-60"</span><span class="nt">&gt;&lt;/p&gt;</span>
                      <span class="nt">&lt;/div&gt;</span>
                    <span class="nt">&lt;/div&gt;</span>
                  <span class="nt">&lt;/a&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;/ul&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
          {{ Form::model($review, array('action' =&gt; array('ReviewsController@store', $product-&gt;id))) }}
          <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"margin: 8px 0"</span><span class="nt">&gt;</span>
            {{ Form::label('email', '評価', ['style' =&gt;  'margin-right:8;']) }}
            {{ Form::selectRange('rate', 1, 10, ['placeholder' =&gt; '評価', 'class' =&gt; 'searh__query', 'style' =&gt; 'text-align: right;']) }}
          <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"margin: 8px 0"</span><span class="nt">&gt;</span>
            {{ Form::textarea('review', '', ['placeholder' =&gt; 'レビューを書いてね！', 'style' =&gt; 'width: 100%;height: 300px;']) }}
          <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col10 push1"</span><span class="nt">&gt;</span>
              {{ Form::submit('投稿する', ['class' =&gt; 'btn btn--block']) }}
            <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
          {!! Form::close() !!}
        <span class="nt">&lt;/article&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjSub"</span><span class="nt">&gt;</span>
@endsection
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">続いて、サインイン中のユーザーを取得してそのユーザーの<code>name</code>をレビューの内容・評価と一緒にReviewモデルに追加しましょう。</p>

<div class="challenge ng-scope">
  <h3>
<i class="icon crown"></i> 問題6：reviewを新規投稿する際、投稿者のnicknameをreviewsテーブルに保存しましょう</h3>
  <div class="challenge_box">
    <h5>作業ファイル：app/Http/Controllers/ReviewsController.php</h5>
    <h5>ヒント①：reviewを保存するメソッドの引数の渡し方を変える必要があります</h5>
    <curriculum-question-container data-order="6" class="ng-scope"><button class="answer ng-hide" ng-click="show_answer()" ng-show="isSolved">解答と解説を見る</button><button class="solve ng-binding" ng-click="solve()" ng-hide="isSolved">課題を解く</button><button class="solved ng-hide" ng-click="solved()" ng-show="isSolving">解けた</button>
</curriculum-question-container>
  </div>
</div>

<p class="ng-scope">それでは実際に確認してみましょう。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/9e22a0a18364eaf07c93211c914e0285.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//9e22a0a18364eaf07c93211c914e0285.png"></p>

<p class="ng-scope"><img src="./応用機能の実装_files/202e63dd4c30bac8e7b487a48a4e0d14.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//202e63dd4c30bac8e7b487a48a4e0d14.png"></p>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4314" class="ng-pristine ng-valid ng-scope">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-6010" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-6010" name="check-6010" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">ニックネームの入力欄を消せた</span></label><!-- end ngRepeat: check in checkbox.checks --><label for="check-6011" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-6011" name="check-6011" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">ニックネームをユーザーにひもづいて設定させることができた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 class="ng-scope" id="31">2.userモデルとreviewモデルの間にアソシエーションを設定する</h2>

<p class="ng-scope">先ほどの課題でnicknameをユーザーとひもづいて設定するようにしました。しかし今後、レビューとレビューを投稿したユーザーのニックネームだけでなく、アイコンも表示したくなるかもしれません。そのときにReviewsテーブルに<code>avatar</code>のカラムを追加するのはあまりよくありません。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/40.png" alt="カラムの追加"></p>

<p class="ng-scope"><strong>表示するUsersテーブルの情報が増えるたびにReviewsテーブルのカラムも増えていくためです。</strong></p>

<p class="ng-scope"><img src="./応用機能の実装_files/41.png" alt="カラムの追加"></p>

<p class="ng-scope">基本的に、あるテーブルのカラムを他のテーブルでも使いたいときに両方にカラムを追加する方法は好ましくありません。仕様が変わってそのカラムが消えたり、名前が変わるときに両方のテーブルのカラムを変更しないといけないからです。</p>

<p class="ng-scope">このような場合は<strong>アソシエーションを設定する</strong>のが正しいやり方です。今回の場合、レビューでUsersテーブルのavatarが必要になったとしても以下のように書けるのでReviewsテーブルにavatarのカラムを追加しなくても良いためです。</p>

<h3 class="ng-scope">[例]</h3>

<div class="code-frame ng-scope" data-lang="php"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nx">review</span><span class="o">-&gt;</span><span class="na">user</span><span class="o">-&gt;</span><span class="na">avatar</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope"><img src="./応用機能の実装_files/80b7ba2901ffeac076011e311c076c54.png" alt="アソシエーション"></p>

<p class="ng-scope">では、レビューを投稿するときにnicknameを設定するのではなく、<strong>レビューを書いたユーザーを設定するようにしましょう。</strong></p>

<p class="ng-scope">レビューは書いたユーザーを<strong>ただ一人</strong>持っています。それに対して、ユーザーは<strong>複数</strong>のレビューを書くことが出来ます。そのため、ReviewモデルとUserモデルの間には<strong>1対多の関係</strong>があります。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/43.png" alt="ReviewモデルとUserモデルのアソシエーション"></p>

<p class="ng-scope">ReviewモデルとUserモデルの間にアソシエーションを設定できれば、Reviewモデルのnicknameカラムは不要となります。なぜなら、<strong>nicknameの情報はアソシエーションで取得できるUserモデルのインスタンスがnameカラムとして持っているからです。</strong></p>

<div class="code-frame ng-scope" data-lang="php"><table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nx">review</span><span class="o">-&gt;</span><span class="na">user</span><span class="o">-&gt;</span><span class="na">name</span>
</pre></div>
</td>
</tr></tbody></table></div>

<p class="ng-scope">nicknameカラムを消して、アソシエーションを使ってレビューを書いたユーザーのnameを取得できるようにしましょう。</p>

<p class="ng-scope">また、ReviewモデルとUserモデルのアソシエーションを設定するにはReviewsテーブルに<strong>user_id</strong>のカラムが必要になります。user_idのカラムがないとレビューを書いたユーザーがどのユーザーか判断することができません。</p>

<p class="ng-scope"><i class="icon attention"></i><strong>Reviewsテーブルのuser_idがNULLのものがあるとエラーが起きます。NULLの部分にUsersテーブルに存在するレコードのidを追加しましょう。</strong></p>

<p class="ng-scope">まずは、nicknameカラムを削除します。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> reviewsテーブルのnicknameカラムを削除するためのマイグレーションファイルを作成しましょう</h3>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="c">#reviewsテーブルからnicknameカラムを削除するためのマイグレーションファイルを作成</span>
<span class="nv">$ </span>php artisan make:migration remove_nickname_from_reviews_table --table<span class="o">=</span>reviews
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">作成したマイグレーションファイルにカラムを削除するための記述を追加します。</p>

<h3 class="ng-scope">
<i class="icon newfile"></i> 新規作成されるファイル</h3>

<ul class="ng-scope">
<li>database/migrations/マイグレーションファイル</li>
</ul>

<h3 class="ng-scope">
<i class="icon information" id="term_425"></i> dropColumnメソッド</h3>

<p class="ng-scope">カラムを作成する際は、stringやtextなどの型を指定していましたが、カラムを削除する場合はdropColumnメソッドを用い、引数に削除したいカラムを指定します。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> nicknameカラム削除のためのマイグレーションファイルを以下のように編集しましょう</h3>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">マイグレーションファイル</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>25
26
27
28
29
30</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">public</span> <span class="k">function</span> <span class="nf">up</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nx">Schema</span><span class="o">::</span><span class="na">table</span><span class="p">(</span><span class="s1">'reviews'</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Blueprint</span> <span class="nv">$table</span><span class="p">)</span> <span class="p">{</span>
<span class="hll">        <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">dropColumn</span><span class="p">(</span><span class="s1">'nickname'</span><span class="p">);</span>
</span>    <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">最後にマイグレーションファイルを実行しましょう。</p>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">ターミナル</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="c">#マイグレーションファイルの実行</span>
<span class="nv">$ </span>php artisan migrate
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">続いて、reviewsテーブルにuser_idカラムを追加します。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> reviewsテーブルにuser_idカラムを追加しましょう</h3>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="c">#reviewsテーブルにuser_idカラムを追加するためのマイグレーションファイルを作成</span>
<span class="nv">$ </span>php artisan make:migration add_user_id_to_reviews_table --table<span class="o">=</span>reviews
</pre></div>
</td>
</tr></tbody></table>
</div>

<h3 class="ng-scope">
<i class="icon newfile"></i> 新規作成されるファイル</h3>

<ul class="ng-scope">
<li>database/migrations/マイグレーションファイル</li>
</ul>

<p class="ng-scope">マイグレーションファイルにuser_idカラム追加の記述を行いましょう。</p>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">マイグレーションファイル</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>13
14
15
16
17
18</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="k">public</span> <span class="k">function</span> <span class="nf">up</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nx">Schema</span><span class="o">::</span><span class="na">table</span><span class="p">(</span><span class="s1">'reviews'</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Blueprint</span> <span class="nv">$table</span><span class="p">)</span> <span class="p">{</span>
<span class="hll">        <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">integer</span><span class="p">(</span><span class="s1">'user_id'</span><span class="p">);</span>
</span>    <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">ターミナル</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="c">#マイグレーションファイルの実行</span>
<span class="nv">$ </span>php artisan migrate
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">次に、ReviewモデルとUserモデルの間にアソシエーションを設定し、review投稿時にuserとreviewを関連付けるための情報を保存するよう実装します。そして、ビューでreviewを表示する際、関連するuserのnameを表示するようビューの記述を書き換えましょう。</p>

<h5 class="ng-scope">
<i class="icon attention"></i> reviewsテーブルのuser_idカラムが空ですとエラーが出ます。なので、全てのuser_idカラムに存在するユーザーのidを入れましょう。</h5>

<div class="challenge ng-scope">
  <h3>
<i class="icon crown"></i> 問題7：reviewとuserの間にアソシエーションを設定しましょう</h3>
  <div class="challenge_box">
    <h5>作業ファイル：<br>app/Review.php<br>app/User.php<br>app/Http/Controllers/ReviewsController.php<br>resources/views/products/show.blade.php</h5>
    <h5>ヒント①：モデル間にアソシエーションを設定する記述をしましょう</h5>
    <h5>ヒント②：reviewを保存する際に、先に作ったカラムに情報を保存する実装をしましょう</h5>
    <h5>ヒント③：ビューでは、一つ一つのreviewのインスタンスから関連するuserを取得し、さらにそのuserのnameカラムの値を取得しましょう</h5>
    <curriculum-question-container data-order="7" class="ng-scope"><button class="answer ng-hide" ng-click="show_answer()" ng-show="isSolved">解答と解説を見る</button><button class="solve ng-binding" ng-click="solve()" ng-hide="isSolved">課題を解く</button><button class="solved ng-hide" ng-click="solved()" ng-show="isSolving">解けた</button>
</curriculum-question-container>
  </div>
</div>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4315" class="ng-pristine ng-valid ng-scope">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-6012" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-6012" name="check-6012" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">Reviewsテーブルのnicknameカラムを消せた</span></label><!-- end ngRepeat: check in checkbox.checks --><label for="check-6013" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-6013" name="check-6013" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">ReviewモデルとUserモデルの間にリレーションを設定できた</span></label><!-- end ngRepeat: check in checkbox.checks --><label for="check-6014" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-6014" name="check-6014" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">作品ページにあるレビューの一覧のニックネームはリレーションを使って取得できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4316" class="ng-pristine ng-valid ng-scope">
  <h4 class="ng-binding">
    <i class="icon check_icon_00"></i>要点チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-6015" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-6015" name="check-6015" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">カラムを削除する場合は<strong>dropColumn()メソッド</strong>を使う</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h1 class="ng-scope" id="32">STEP8：マイページを実装しよう</h1>

<p class="ng-scope">最後に今まで自分の書いたレビューの一覧が見られるマイページを実装しましょう。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/34.png" alt="マイページ"></p>

<h3 class="ng-scope">
<i class="icon dashboard"></i> 作業内容</h3>

<h5 class="ng-scope">1.マイページに遷移できるようにする</h5>

<h5 class="ng-scope">2.マイページのビューを追加する</h5>

<h5 class="ng-scope">3.ユーザーの情報を表示する</h5>

<h5 class="ng-scope">4.自分のレビューの一覧を表示する</h5>

<h2 class="ng-scope" id="33">1.マイページに遷移できるようにする</h2>

<p class="ng-scope">マイページは、userの詳細ページだということもできます。Laravelの7つのアクションでは、詳細ページはshowというアクションにより呼び出します。そこで、UsersControllerを作成し、<code>show</code>アクションを定義しましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> 下記のコマンドを実行し、UsersControllerを作成しましょう</h3>

<div class="code-frame ng-scope" data-lang="bash">
<div class="code-lang"><span class="bold">terminal</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="c">#UsersControllerを作成</span>
<span class="nv">$ </span>php artisan make:controller UsersController
</pre></div>
</td>
</tr></tbody></table>
</div>

<h3 class="ng-scope">
<i class="icon pen"></i> 作成したapp/Http/Controllers/UsersControllerにshowアクションを定義しましょう</h3>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">UsersController</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">App\Http\Controllers</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Http\Requests</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UsersController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
<span class="hll">    <span class="k">public</span> <span class="k">function</span> <span class="nf">show</span><span class="p">()</span>
</span><span class="hll">    <span class="p">{</span>
</span><span class="hll">        <span class="k">return</span> <span class="nx">view</span><span class="p">(</span><span class="s1">'users.show'</span><span class="p">);</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="p">}</span>
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">続いてルーティングです。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> config/routes.phpに下記を追記しましょう</h3>

<div class="code-frame ng-scope" data-lang="php">
<div class="code-lang"><span class="bold">routes.php</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="s1">'ProductsController@index'</span><span class="p">);</span>

<span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">'/products/search/'</span><span class="p">,</span> <span class="s1">'ProductsController@search'</span><span class="p">);</span>

<span class="nx">Route</span><span class="o">::</span><span class="na">resource</span><span class="p">(</span><span class="s1">'products'</span><span class="p">,</span> <span class="s1">'ProductsController'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'only'</span> <span class="o">=&gt;</span> <span class="s1">'show'</span><span class="p">]);</span>

<span class="nx">Route</span><span class="o">::</span><span class="na">resource</span><span class="p">(</span><span class="s1">'products.reviews'</span><span class="p">,</span> <span class="s1">'ReviewsController'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'only'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'create'</span><span class="p">,</span> <span class="s1">'store'</span><span class="p">]]);</span>

<span class="nx">Route</span><span class="o">::</span><span class="na">auth</span><span class="p">();</span>

<span class="hll"><span class="nx">Route</span><span class="o">::</span><span class="na">resource</span><span class="p">(</span><span class="s1">'users'</span><span class="p">,</span> <span class="s1">'UsersController'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'only'</span> <span class="o">=&gt;</span> <span class="s1">'show'</span><span class="p">]);</span>
</span></pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope">次に、マイページに遷移するボタンを作成します。マイページに移動するボタンは以下のようにヘッダーの「投稿するボタン」と「サインアウトボタン」の間におきましょう。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/39.png" alt="マイページボタン"></p>

<p class="ng-scope">このボタンを押したときの遷移先は<a href="http://localhost:8000/users/%E3%82%B5%E3%82%A4%E3%83%B3%E3%82%A4%E3%83%B3%E4%B8%AD%E3%81%AE%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%81%AEid" target="_blank">/users/サインイン中のユーザーのid</a>です。呼ばれるアクションは、先ほど作成した<strong>UsersControllerのshowアクション</strong>です。</p>

<p class="ng-scope">また、ログインしていないのにこのマイページボタンを押されるとユーザーのidがないため困りますね。そこで<strong>ログインをしていない時にこのボタンを表示しない</strong>ようにビューに追記しましょう。</p>

<h3 class="ng-scope">
<i class="icon pen"></i> resources/views/review_site.blade.phpを、以下のように編集しましょう</h3>

<div class="code-frame ng-scope" data-lang="rhtml">
<div class="code-lang"><span class="bold">review_site.blade.php</span></div>
<table class="highlighttable"><tbody><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td>
<td class="code">
<div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">class=</span><span class="s">"pc"</span> <span class="na">lang=</span><span class="s">"ja"</span> <span class="na">xmlns:fb=</span><span class="s">"http://ogp.me/ns/fb#"</span> <span class="na">xmlns:og=</span><span class="s">"http://ogp.me/ns#"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;title&gt;</span>映画レビューサイト<span class="nt">&lt;/title&gt;</span>
      <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">'/css/review_site.css'</span> <span class="na">rel=</span><span class="s">'stylesheet'</span> <span class="na">type=</span><span class="s">'text/css'</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/meta&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body</span> <span class="na">class=</span><span class="s">"yj950-2"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"wrapper"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"yjContentsHeader"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">"globalnav"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"globalnav__menu"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"gmenu"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"logo"</span> <span class="na">style=</span><span class="s">"float: left"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/"</span><span class="nt">&gt;</span>mooovi<span class="nt">&lt;/a&gt;</span>
              <span class="nt">&lt;/li&gt;</span>
<span class="hll">              @if (Auth::check())
</span><span class="hll">              <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"entry_button"</span> <span class="na">style=</span><span class="s">"float: right"</span><span class="nt">&gt;</span>
</span><span class="hll">                <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/logout"</span><span class="nt">&gt;</span>サインアウト<span class="nt">&lt;/a&gt;</span>
</span><span class="hll">              <span class="nt">&lt;/li&gt;</span>
</span><span class="hll">              <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"entry_button"</span> <span class="na">style=</span><span class="s">"float: right"</span><span class="nt">&gt;</span>
</span><span class="hll">                <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/users/{{ Auth::user()-&gt;id }}"</span><span class="nt">&gt;</span>マイページ<span class="nt">&lt;/a&gt;</span>
</span><span class="hll">              <span class="nt">&lt;/li&gt;</span>
</span><span class="hll">              @endif
</span>              <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"entry_button"</span> <span class="na">style=</span><span class="s">"float: right"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/products/search"</span><span class="nt">&gt;</span>投稿する<span class="nt">&lt;/a&gt;</span>
              <span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;/ul&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/nav&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      #以下略
</pre></div>
</td>
</tr></tbody></table>
</div>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4318" class="ng-pristine ng-valid ng-scope">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-6017" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-6017" name="check-6017" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">ヘッダーにマイページへ遷移するボタンを作成できた</span></label><!-- end ngRepeat: check in checkbox.checks --><label for="check-6018" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-6018" name="check-6018" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">ログインしていないときにはマイページボタンが表示されないようにできた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 class="ng-scope" id="34">2.マイページのビューを追加する</h2>

<p class="ng-scope">マイページに関するルーティング、コントローラの作成が出来たので、次にビューの作成をしていきましょう。</p>

<p class="ng-scope">コントローラーのアクションは、同名のビューファイルを呼び出すようにします。先ほどUsersControllerのshowアクションに<code>return view('users.show')</code>と記述したので呼び出されるviewファイルはresources/views/users/show.blade.phpです。</p>

<p class="ng-scope"><br></p>

<p class="ng-scope">ビューファイルに関しては、先ほどダウンロードした<strong>Laravel2-4フォルダ</strong>にあるファイルを指定したディレクトリに追加しましょう。</p>

<p class="ng-scope">ダウンロードしたフォルダを消してしまった人は以下のリンクからもう一度ダウンロードしてください。</p>

<p class="ng-scope"><a href="https://www.dropbox.com/s/o0hmrc58h7co705/Laravel2-4.zip?dl=1" target="_blank">Laravel2-4.zip</a></p>

<p class="ng-scope">追加するファイルは以下のファイルです。</p>

<ul class="ng-scope">
<li><strong>Laravel2-4/users/show.blade.php</strong></li>
</ul>

<h3 class="ng-scope">
<i class="icon pen"></i> ダウンロードしたLaravel2フォルダに入っている<code>show.blade.php</code>ファイルをviews/usersフォルダに移動しましょう</h3>

<p class="ng-scope"><strong>追加するディレクトリ(mooovi)</strong></p>

<ul class="filetree ng-scope">
  <li class="t-folder"> resources
    <ul>
      <li class="t-folder"> views
        <ul>
          <li class="t-folder"> users
            <ul>
              <li class="t-file"> <strong>show.blade.php ←ここに追加</strong> </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p class="ng-scope"><strong>新しく置き換えるファイル(ダウンロードしたLaravel2-4)</strong></p>

<ul class="filetree ng-scope">
  <li class="t-folder"> Laravel2-4
    <ul>
      <li class="t-folder"> users
        <ul>
          <li class="t-file"> <strong>show.blade.php</strong>
</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4320" class="ng-pristine ng-valid ng-scope">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-6020" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-6020" name="check-6020" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding"><strong>Laravel2-4/users/show.html.erb</strong>を指定したディレクトリに追加できた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 class="ng-scope" id="35">3.ユーザーの情報を表示する</h2>

<p class="ng-scope">いまの状態では表示されているユーザーの情報は適当ですね。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/44.png" alt="マイページ"></p>

<p class="ng-scope">マイページなので表示する情報は自分の情報にしましょう。マイページ画面で呼ばれるアクションは<strong>UsersControllerのshowアクション</strong>なので、対応するビューは<code>resources/views/users/show.blade.php</code>となります。</p>

<div class="challenge ng-scope">
  <h3>
<i class="icon crown"></i> 問題8：マイページに、ログイン中のuserの情報を表示しましょう</h3>
  <div class="challenge_box">
    <h5>作業ファイル：
　　　<br>resources/views/users/show.blade.php</h5>
    <h5>ヒント：imgタグのsrc属性を指定すると、ログインしているユーザのアバターを表示することができます</h5>
    <curriculum-question-container data-order="8" class="ng-scope"><button class="answer ng-hide" ng-click="show_answer()" ng-show="isSolved">解答と解説を見る</button><button class="solve ng-binding" ng-click="solve()" ng-hide="isSolved">課題を解く</button><button class="solved ng-hide" ng-click="solved()" ng-show="isSolving">解けた</button>
</curriculum-question-container>
  </div>
</div>

<p class="ng-scope">コードを記述したら、さきほどまで適当だったユーザー情報が、自分で登録したユーザー情報になっていることを確認しましょう。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/ef9ffcf5cf0a2cd7c791301391ff37fb.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//ef9ffcf5cf0a2cd7c791301391ff37fb.png"></p>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4321" class="ng-pristine ng-valid ng-scope">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-6021" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-6021" name="check-6021" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">マイページで自分の情報を表示させることができた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 class="ng-scope" id="36">4.自分のレビューの一覧表示する</h2>

<p class="ng-scope">最後に表示されているレビューも自分のレビューの情報にしましょう。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/45.png" alt="マイページ"></p>

<p class="ng-scope">自分のレビューの情報はアソシエーションを使えば取得できますね。<br>
今回も呼ばれるアクションはUsersControllerのshowアクションなので、対応するビューは<strong>resources/views/users/show.blade.php</strong>となります。</p>

<div class="challenge ng-scope">
  <h3>
<i class="icon crown"></i> 問題9：マイページにおいて、自分が投稿したレビューの一覧を表示しましょう</h3>
  <div class="challenge_box">
    <h5>作業ファイル：
　　　<br>resources/views/users/show.blade.php</h5>
    <h5>ヒント：自分の書いたレビューの一覧はUserモデルとReviewモデルのアソシエーションを使って取得しましょう</h5>
    <curriculum-question-container data-order="9" class="ng-scope"><button class="answer ng-hide" ng-click="show_answer()" ng-show="isSolved">解答と解説を見る</button><button class="solve ng-binding" ng-click="solve()" ng-hide="isSolved">課題を解く</button><button class="solved ng-hide" ng-click="solved()" ng-show="isSolving">解けた</button>
</curriculum-question-container>
  </div>
</div>

<p class="ng-scope">マイページで、レビューを投稿した作品が表示されていることを確認しましょう。</p>

<p class="ng-scope"><img src="./応用機能の実装_files/c438596bfbe3d8093036b9af65353223.png" alt="https://tech-master.s3.amazonaws.com/uploads/curriculums//c438596bfbe3d8093036b9af65353223.png"></p>

<p class="ng-scope"><form action="http://master.tech-camp.in/curriculums/899#" data-id="4322" class="ng-pristine ng-valid ng-scope">
  <h4 class="ng-binding">
    <i class="icon check_icon_01"></i>作業チェック
  </h4>
  <!-- ngRepeat: check in checkbox.checks --><label for="check-6022" ng-repeat="check in checkbox.checks" class="ng-scope"><input id="check-6022" name="check-6022" ng-change="change_checkbox_value(check)" ng-model="check.checked" type="checkbox" class="ng-pristine ng-untouched ng-valid"><span ng-bind-html="check.text" class="ng-binding">マイページで自分のレビューの一覧を表示させることができた</span></label><!-- end ngRepeat: check in checkbox.checks -->
</form></p>

<h2 class="ng-scope" id="37">以上で、moooviアプリの実装は全て終了です</h2>

<p class="ng-scope">以下のリンクより、見本のソースコードをダウンロードして自分のソースコードと照らし合わせてみましょう。</p>

<p class="ng-scope"><a href="https://www.dropbox.com/s/kbfse828ugzlore/mooovi.zip?dl=1" target="_blank">mooovi.zip</a></p>

<h2 class="ng-scope" id="38">Lesson6 Gitに取り組もう</h2>

<p class="ng-scope">moooviの実装、お疲れ様でした！ここまでで、Laravelがどのようにアプリケーションとして成り立っているかの知識は大分ついたかと思います。</p>

<h3 class="ng-scope">通常コース(一ヶ月、二ヶ月、イナズマ)を受講中の方</h3>

<p class="ng-scope"><strong>この次は、次章「もう一度moooviを作成しよう」ではなく、「Lesson6 Git」に進んでください。</strong></p>

<h3 class="ng-scope">研修コースを受講中の方</h3>

<p class="ng-scope"><strong>次章「もう一度moooviを作成しよう」に取り組まなくても「Lesson6 Git」に進んで構いません。ただし、最後にある確認問題に解答してください。こちらはこれまでの知識で解答可能な簡単なチェックになっております。</strong></p>

<p class="ng-scope">「Lesson6 Git」の中で、再度基本カリキュラムLesson4で取り組んだPictweetを作成していただく機会があります。多くの他の学習と同じく、プログラミングの学習においても復習はとても大切ですので、<strong>必ず取り組んでください。</strong></p>

<p class="ng-scope"><a href="http://master.tech-camp.in/curriculums/26" target="_blank">Lesson6 Gitの基礎を学ぼう</a></p>
</div>
          <!-- ngIf: curriculum.short_test --><div class="short_test-box ng-scope" ng-if="curriculum.short_test">
  <div class="short_test-title">
    <h4>
      確認問題
    </h4>
    <p>
      お疲れ様でした！このカリキュラムの終わりに確認問題を解きましょう。
    </p>
  </div>
  <div class="short_test_score" id="shortTestInfo"></div>
  <div class="short_test-button">
    <a class="curriculum-short-test-button" ng-click="showShortTest(curriculum.short_test.id)">確認テストに挑戦する！</a>
  </div>
</div><!-- end ngIf: curriculum.short_test -->
        </div>
      </div>
      <div class="col-md-3 col-sm-12" id="curriculumSideContainer">
        <curriculum-side-wrap id="sideWrap">
          <ul class="list-group toc-tree" id="curriculumContents" style="max-height: 426px;">
  <li class="list-group-item disabled">
    目次
  </li>
  <!-- ngRepeat: content in contents --><li ng-repeat="content in contents" class="ng-scope">
    <a class="content-link ng-binding" id="contents1" ng-click="clickContent(content.h1.id)">学習目標</a>
    <ul class="list-group">
      <!-- ngRepeat: h2 in content.h2 track by $index -->
    </ul>
  </li><!-- end ngRepeat: content in contents --><li ng-repeat="content in contents" class="ng-scope">
    <a class="content-link ng-binding" id="contents2" ng-click="clickContent(content.h1.id)">学習課題</a>
    <ul class="list-group">
      <!-- ngRepeat: h2 in content.h2 track by $index -->
    </ul>
  </li><!-- end ngRepeat: content in contents --><li ng-repeat="content in contents" class="ng-scope">
    <a class="content-link ng-binding" id="contents3" ng-click="clickContent(content.h1.id)">STEP0：作業の準備をしよう</a>
    <ul class="list-group">
      <!-- ngRepeat: h2 in content.h2 track by $index --><li ng-repeat="h2 in content.h2 track by $index" class="ng-scope">
        <a class="content-link ng-binding" id="contents4" ng-click="clickContent(h2.id)">ファイルをダウンロードしよう</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index -->
    </ul>
  </li><!-- end ngRepeat: content in contents --><li ng-repeat="content in contents" class="ng-scope">
    <a class="content-link ng-binding" id="contents5" ng-click="clickContent(content.h1.id)">STEP1：レビューの評価を星として表示させよう</a>
    <ul class="list-group">
      <!-- ngRepeat: h2 in content.h2 track by $index --><li ng-repeat="h2 in content.h2 track by $index" class="ng-scope">
        <a class="content-link ng-binding" id="contents6" ng-click="clickContent(h2.id)">１．個別の作品ページでレビューの星を表示する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li ng-repeat="h2 in content.h2 track by $index" class="ng-scope">
        <a class="content-link ng-binding" id="contents7" ng-click="clickContent(h2.id)">２．映画一覧ページでそれぞれの映画の平均評価を取得する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li ng-repeat="h2 in content.h2 track by $index" class="ng-scope">
        <a class="content-link ng-binding" id="contents8" ng-click="clickContent(h2.id)">３．Product.phpにメソッドを定義する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index -->
    </ul>
  </li><!-- end ngRepeat: content in contents --><li ng-repeat="content in contents" class="ng-scope">
    <a class="content-link ng-binding" id="contents9" ng-click="clickContent(content.h1.id)">STEP2：ランキング機能を実装しよう</a>
    <ul class="list-group">
      <!-- ngRepeat: h2 in content.h2 track by $index --><li ng-repeat="h2 in content.h2 track by $index" class="ng-scope">
        <a class="content-link ng-binding" id="contents10" ng-click="clickContent(h2.id)">1.__construct()メソッドを設定する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li ng-repeat="h2 in content.h2 track by $index" class="ng-scope">
        <a class="content-link ng-binding" id="contents11" ng-click="clickContent(h2.id)">2.取得したproduct情報をビューに渡す</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li ng-repeat="h2 in content.h2 track by $index" class="ng-scope">
        <a class="content-link ng-binding" id="contents12" ng-click="clickContent(h2.id)">3.ランキングを表示させる</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li ng-repeat="h2 in content.h2 track by $index" class="ng-scope">
        <a class="content-link ng-binding" id="contents13" ng-click="clickContent(h2.id)">4.productsテーブルから、レビュー数が多い順に5件レコードを取得する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index -->
    </ul>
  </li><!-- end ngRepeat: content in contents --><li ng-repeat="content in contents" class="ng-scope">
    <a class="content-link ng-binding" id="contents14" ng-click="clickContent(content.h1.id)">STEP3：ユーザーのサインアップ画面をつくろう</a>
    <ul class="list-group">
      <!-- ngRepeat: h2 in content.h2 track by $index --><li ng-repeat="h2 in content.h2 track by $index" class="ng-scope">
        <a class="content-link ng-binding" id="contents15" ng-click="clickContent(h2.id)">1.viewファイルを作成</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li ng-repeat="h2 in content.h2 track by $index" class="ng-scope">
        <a class="content-link ng-binding" id="contents16" ng-click="clickContent(h2.id)">2.必要なファイルを入れ替える</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index -->
    </ul>
  </li><!-- end ngRepeat: content in contents --><li ng-repeat="content in contents" class="ng-scope">
    <a class="content-link ng-binding" id="contents17" ng-click="clickContent(content.h1.id)">STEP4：サインアウト、ログイン機能をつけよう</a>
    <ul class="list-group">
      <!-- ngRepeat: h2 in content.h2 track by $index --><li ng-repeat="h2 in content.h2 track by $index" class="ng-scope">
        <a class="content-link ng-binding" id="contents18" ng-click="clickContent(h2.id)">1.サインアウトボタンを設置する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li ng-repeat="h2 in content.h2 track by $index" class="ng-scope">
        <a class="content-link ng-binding" id="contents19" ng-click="clickContent(h2.id)">2.サインアウト後のリダイレクトを設定する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li ng-repeat="h2 in content.h2 track by $index" class="ng-scope">
        <a class="content-link ng-binding" id="contents20" ng-click="clickContent(h2.id)">3.サインインしていない場合はログイン画面にリダイレクトさせる</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index -->
    </ul>
  </li><!-- end ngRepeat: content in contents --><li ng-repeat="content in contents" class="ng-scope">
    <a class="content-link ng-binding" id="contents21" ng-click="clickContent(content.h1.id)">STEP5：intervention/imageを使って画像のアップロード機能をつけよう</a>
    <ul class="list-group">
      <!-- ngRepeat: h2 in content.h2 track by $index --><li ng-repeat="h2 in content.h2 track by $index" class="ng-scope">
        <a class="content-link ng-binding current" id="contents22" ng-click="clickContent(h2.id)">1.intervention/imageをインストールする</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li ng-repeat="h2 in content.h2 track by $index" class="ng-scope">
        <a class="content-link ng-binding" id="contents23" ng-click="clickContent(h2.id)">2.usersテーブルにカラムを追加する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li ng-repeat="h2 in content.h2 track by $index" class="ng-scope">
        <a class="content-link ng-binding" id="contents24" ng-click="clickContent(h2.id)">3.アプリケーションに画像ファイルを保存できるようにする</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index -->
    </ul>
  </li><!-- end ngRepeat: content in contents --><li ng-repeat="content in contents" class="ng-scope">
    <a class="content-link ng-binding" id="contents25" ng-click="clickContent(content.h1.id)">STEP6：画像を保存できるようにしよう</a>
    <ul class="list-group">
      <!-- ngRepeat: h2 in content.h2 track by $index --><li ng-repeat="h2 in content.h2 track by $index" class="ng-scope">
        <a class="content-link ng-binding" id="contents26" ng-click="clickContent(h2.id)">1.avatarが保存できるようにする</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li ng-repeat="h2 in content.h2 track by $index" class="ng-scope">
        <a class="content-link ng-binding" id="contents27" ng-click="clickContent(h2.id)">2.Userモデルにプロパティを設定する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li ng-repeat="h2 in content.h2 track by $index" class="ng-scope">
        <a class="content-link ng-binding" id="contents28" ng-click="clickContent(h2.id)">3.バリデーションを設定する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index -->
    </ul>
  </li><!-- end ngRepeat: content in contents --><li ng-repeat="content in contents" class="ng-scope">
    <a class="content-link ng-binding" id="contents29" ng-click="clickContent(content.h1.id)">STEP7：アソシエーションを利用しよう</a>
    <ul class="list-group">
      <!-- ngRepeat: h2 in content.h2 track by $index --><li ng-repeat="h2 in content.h2 track by $index" class="ng-scope">
        <a class="content-link ng-binding" id="contents30" ng-click="clickContent(h2.id)">1.ニックネームの入力欄を消す</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li ng-repeat="h2 in content.h2 track by $index" class="ng-scope">
        <a class="content-link ng-binding" id="contents31" ng-click="clickContent(h2.id)">2.userモデルとreviewモデルの間にアソシエーションを設定する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index -->
    </ul>
  </li><!-- end ngRepeat: content in contents --><li ng-repeat="content in contents" class="ng-scope">
    <a class="content-link ng-binding" id="contents32" ng-click="clickContent(content.h1.id)">STEP8：マイページを実装しよう</a>
    <ul class="list-group">
      <!-- ngRepeat: h2 in content.h2 track by $index --><li ng-repeat="h2 in content.h2 track by $index" class="ng-scope">
        <a class="content-link ng-binding" id="contents33" ng-click="clickContent(h2.id)">1.マイページに遷移できるようにする</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li ng-repeat="h2 in content.h2 track by $index" class="ng-scope">
        <a class="content-link ng-binding" id="contents34" ng-click="clickContent(h2.id)">2.マイページのビューを追加する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li ng-repeat="h2 in content.h2 track by $index" class="ng-scope">
        <a class="content-link ng-binding" id="contents35" ng-click="clickContent(h2.id)">3.ユーザーの情報を表示する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li ng-repeat="h2 in content.h2 track by $index" class="ng-scope">
        <a class="content-link ng-binding" id="contents36" ng-click="clickContent(h2.id)">4.自分のレビューの一覧表示する</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li ng-repeat="h2 in content.h2 track by $index" class="ng-scope">
        <a class="content-link ng-binding" id="contents37" ng-click="clickContent(h2.id)">以上で、moooviアプリの実装は全て終了です</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index --><li ng-repeat="h2 in content.h2 track by $index" class="ng-scope">
        <a class="content-link ng-binding" id="contents38" ng-click="clickContent(h2.id)">Lesson6 Gitに取り組もう</a>
      </li><!-- end ngRepeat: h2 in content.h2 track by $index -->
    </ul>
  </li><!-- end ngRepeat: content in contents -->
</ul>
          <div class="progress_box ng-scope" ng-show="check_count &gt; 0">
  <!-- ngIf: showTroubleShooting() -->
  <!-- ngIf: courseId != 9 && courseId != 10 --><p class="terms ng-scope" ng-if="courseId != 9 &amp;&amp; courseId != 10">
    分からない用語がある時：<br><a href="http://master.tech-camp.in/terms" target="_brank">用語一覧集</a>
  </p><!-- end ngIf: courseId != 9 && courseId != 10 -->
  <h4>
    進捗度<i id="numerator" class="ng-binding">16 / 45<span id="denominaotr"></span></i>
  </h4>
  <div class="progress">
    <div aria-valuemax="100" aria-valuemin="0" aria-valuenow="35.6" class="pregress-bar progress-bar-info ng-binding" role="progressbar" style="width: 35.6%;">
      35.6%
    </div>
  </div>
</div>
          <curriculum-glossary ng-show="curriculum.curriculum_type == 2 || curriculum.curriculum_type == 3" class="ng-hide"></curriculum-glossary>
          <button class="curriculum-report-button" ng-click="show_curriculum_report()">
            <img src="./応用機能の実装_files/idea.svg" width="20px" height="20px">
            | このカリキュラムへのご要望
          </button>
        </curriculum-side-wrap>
      </div>
    </div>
    <ul class="pager" ng-hide="loading">
  <li class="previous">
    <a ng-click="go_previous()" ng-show="curriculum.previous_id" class="">前のカリキュラム</a>
  </li>
  <li class="next">
    <a ng-class="{ disable: curriculum.short_test.can_see_next_curriculum == false }" ng-click="go_next()" ng-show="curriculum.next_id" class="disable">次のカリキュラム</a>
  </li>
</ul>
  </div>
</curriculum>
<div id="loading" ng-show="loading" class="ng-scope ng-isolate-scope ng-hide">
  <svg height="44" stroke="#444" viewBox="0 0 44 44" width="44" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd" strole-width="2"><circle cx="22" cy="22" r="3.56088"><animate attributeName="r" begin="0s" calcMode="spline" dur="1.8s" keySplines="0.165, 0.84, 0.44, 1" keyTimes="0; 1" repeatCount="indefinite" values="1; 20"></animate><animate attributeName="stroke-opacity" begin="0s" calcMode="spline" dur="1.8s" keySplines="0.3, 0.61, 0.355, 1" keyTimes="0; 1" repeatCount="indefinite" values="1; 0"></animate></circle><circle cx="22" cy="22" r="18.6215"><animate attributeName="r" begin="-0.9s" calcMode="spline" dur="1.8s" keySplines="0.165, 0.84, 0.44, 1" keyTimes="0; 1" repeatCount="indefinite" values="1; 20"></animate><animate attributeName="stroke-opacity" begin="-0.9s" calcMode="spline" dur="1.8s" keySplines="0.3, 0.61, 0.355, 1" keyTimes="0; 1" repeatCount="indefinite" values="1; 0"></animate></circle></g></svg>
</div>

<div class="curriculum-image__modal modal ng-scope" id="curriculum-image__modal" role="dialog" tabindex="-1" style="width: 0px;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button class="close" data-dismiss="modal" ng-click="close()"><span aria-hidden="true">×</span></button>
      </div>
      <div class="modal-body">
        <div class="curriculum-image__img__body">
          <img class="curriculum-image__img zoom-out" id="curriculum-image__img">
        </div>
      </div>
    </div>
  </div>
</div>

<style type="text/css" class="ng-scope">
  .curriculum-inner{position: relative;}
  #curriculumSideContainer{position: static;}
  #sideWrap{display: block;}
  .fixed-side{position: fixed; top :110px}
  .absoluted-side-bottom{position: absolute; bottom :0}
  .toc-tree{position: relative; overflow-y: auto;}
  .content-link {cursor: pointer;}
</style>
</div><div id="js-support-popwindow"><div class="popwindow_box" style="bottom: -400px;"><div id="minimization_btn"><h3>メンターを呼ぶ</h3><div class="minimization_btn">−</div></div><p>質問がある際は、こちらからメンターを呼ぶことができます</p><div class="form_box" id="before_sent"><form accept-charset="UTF-8" action="http://master.tech-camp.in/office_question_notifications" class="new_office_question_notification ng-pristine ng-valid" data-remote="true" id="new_office_question_notification" method="post"><div style="display:none"><input name="utf8" type="hidden" value="✓"></div><input id="office_question_notification_user_id" name="office_question_notification[user_id]" type="hidden" value="7534"><input id="office_question_notification_coming_log_id" name="office_question_notification[coming_log_id]" type="hidden" value="48739"><input class="form_box-address" id="office_question_notification_seat_number" name="office_question_notification[seat_number]" placeholder="座席番号を入力" type="number"><input class="form_box-submit" data-disable-with="送信中" disabled="disabled" name="commit" type="submit" value="メンターを呼ぶ"></form></div><div class="form_box_after" id="after_sent"><p>少々お待ちください</p></div><div class="form_box_after" id="not_sent"><p>エキスパートコースの方はこの時間は質問できません</p></div></div><div class="minimized_window" id="popwindow_box"><div class="minimized_window_btns"><a class="minimized_window_btn mentor_question_btn" id="maximization_btn">メンターを呼ぶ</a><a class="go_out_btn minimized_window_btn" data-method="patch" href="http://master.tech-camp.in/me/comings/7534?coming=go_out" rel="nofollow" target="_self">退席する</a></div></div></div><div id="office_map_panel"><div id="office_map_content"><div class="modal-close">× 閉じる</div><img alt="Office b map" src="./応用機能の実装_files/office_B_map-4e3458b1f36bf644a786bea9e5b2455a.jpeg"><hr><img alt="Office a map" src="./応用機能の実装_files/office_A_map-a3f60ec5e82fded6c214ff36497646f4.jpeg"></div></div><div class="tooltip" id="tooltip0" style="opacity: 0.8; left: -9999px; top: 48746px;"><p>研修内容で習った事関しては全て理解・習得し、1人で一通りできるようになる。</p></div></body></html>